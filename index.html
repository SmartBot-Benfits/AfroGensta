<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>AfroGenstas — Music Meets Finance (Professional Edition)</title>

<!-- Google Fonts (Figma spec fonts) -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- AdSense Placeholder (Uncomment and replace with your ad unit for production) -->
<!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXX"></script> -->

<style>
/* ================= Design system: Enhanced Figma-style spec ================= */
:root{
  /* Palette - Refined for professionalism */
  --primary:#FF6B00; /* Vibrant Orange for CTAs */
  --secondary:#00FFD1; /* Teal for accents */
  --accent:#FF2E97; /* Pink for highlights */
  --bg:#07060A; /* Deep space black */
  --surface:#0E0E12; /* Card backgrounds */
  --muted:#B3B3B3; /* Subtext */
  --glass: rgba(255,255,255,0.03); /* Glassmorphism */
  --card: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));
  --radius:12px;
  --maxW:1200px;
  --shadow: 0 8px 32px rgba(2,6,23,0.6);
  --transition: 240ms cubic-bezier(.2,.9,.2,1);
  --ui-size:14px;
  --success: #2dd4bf;
  --danger: #ff6b6b;
}

/* Base - Improved accessibility */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:radial-gradient(900px 400px at 8% 8%, rgba(124,92,255,0.035), transparent), var(--bg); color:#fff; -webkit-font-smoothing:antialiased; font-family: 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, Arial;}
a{color:inherit;text-decoration:none}
button{font-family:inherit;cursor:pointer}
:focus{outline:2px solid var(--primary);outline-offset:2px}

/* Header - Sticky with shadow */
header{
  position:sticky; top:0; z-index:120; display:flex; align-items:center; justify-content:space-between;
  padding:14px 16px; backdrop-filter: blur(8px); background:linear-gradient(180deg, rgba(3,4,8,0.6), rgba(3,4,8,0.25));
  border-bottom: 1px solid rgba(255,255,255,0.03); box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent));display:grid;place-items:center;font-weight:800;font-family:'Orbitron',sans-serif;box-shadow:0 8px 28px rgba(124,92,255,0.08)}
.header-title{font-weight:700;line-height:1}
.header-sub{font-size:12px;color:var(--muted)}

/* Nav - Hover effects */
nav{display:flex;gap:10px;align-items:center}
nav button{background:transparent;border:none;color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700;transition: all var(--transition); font-size:14px}
nav button:hover{color:#fff;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));transform:translateY(-1px)}
nav button.active{color:#fff;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}

/* Layout - Responsive grid */
main{max-width:var(--maxW);margin:14px auto;padding:12px;display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:1000px){ main{grid-template-columns:720px 1fr} }

/* Card - Enhanced hover and focus */
.card{background:var(--card); border-radius:var(--radius); padding:14px; border:1px solid rgba(255,255,255,0.03); box-shadow:var(--shadow); transition: transform var(--transition), box-shadow var(--transition);}
.card:hover, .card:focus-within{ transform: translateY(-4px); box-shadow: 0 14px 46px rgba(2,6,23,0.72) }

/* Typography - Better spacing */
h1{font-family:'Orbitron',sans-serif;margin:0;font-size:28px}
h2{margin:0;font-size:20px;font-weight:700}
h3{margin:0;font-size:16px;font-weight:700}
.muted{color:var(--muted);font-size:14px}
.small{font-size:12px;color:var(--muted)}

/* Ticker & lists - Scroll snap */
.ticker{display:flex;gap:10px;overflow-x:auto;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));white-space:nowrap;scroll-snap-type:x mandatory}
.tick{min-width:150px;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.02);scroll-snap-align:start}

/* Grid cards - Responsive */
.grid-cards{display:grid;gap:12px}
@media(min-width:680px){ .grid-cards{grid-template-columns:repeat(2,1fr)} }
@media(min-width:1000px){ .grid-cards{grid-template-columns:repeat(3,1fr)} }

/* Table - Zebra striping */
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
.table th{color:var(--primary);font-weight:700}
.table tbody tr:nth-child(even){background:rgba(255,255,255,0.01)}

/* Buttons & inputs - Accessibility */
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.input{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;min-width:0;transition:border var(--transition)}
.input:focus{border-color:var(--primary)}
.btn{background:linear-gradient(90deg,var(--secondary),var(--primary));border:none;padding:10px 14px;border-radius:12px;color:#021;font-weight:800;transition:transform var(--transition), box-shadow var(--transition)}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(255,107,0,0.3)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}
.btn.ghost:hover{border-color:var(--primary)}
.btn:active{transform:translateY(1px)}

/* Posters & gallery - Lazy load */
.poster{width:120px;height:120px;border-radius:12px;overflow:hidden;flex:0 0 auto;cursor:pointer;box-shadow:0 10px 22px rgba(2,6,23,0.5);transition:transform var(--transition)}
.poster img{width:100%;height:100%;object-fit:cover;display:block;loading:lazy}
.poster:hover{transform:scale(1.05)}

/* Spotlight 3D frame - Fullscreen support */
.three-wrap{width:100%;height:260px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));display:flex;align-items:center;justify-content:center}
.sketch{width:100%;height:100%;border:0}

/* Lightbox - Fade in */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.82);display:none;place-items:center;z-index:240;transition:opacity 300ms}
.lightbox.show{display:grid;opacity:1}
.lightbox img{max-width:92%;max-height:86%;border-radius:12px;transition:transform 300ms}
.lightbox img:hover{transform:scale(1.02)}

/* Footer - Legal links */
footer{padding:12px;text-align:center;color:var(--muted);font-size:13px;margin-top:8px}
footer a{color:var(--secondary);text-decoration:underline}

/* Toast - Positioned */
.toast{position:fixed;right:18px;bottom:110px;background:linear-gradient(90deg,var(--secondary),var(--primary));padding:10px 14px;border-radius:12px;color:#021;font-weight:800;z-index:320;opacity:0;transform:translateY(10px);transition:all 300ms}
.toast.show{opacity:1;transform:translateY(0)}

/* Bottom nav - 3D icons with tooltips */
.bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:330;display:flex;gap:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 16px 40px rgba(3,6,20,0.6)}
.nav-item{width:56px;height:56px;border-radius:14px;display:grid;place-items:center;cursor:pointer;transition:transform var(--transition), box-shadow var(--transition);position:relative}
.nav-item .icon{width:36px;height:36px;transition:transform var(--transition)}
.nav-item.active{transform:translateY(-6px);box-shadow:0 12px 30px rgba(124,92,255,0.12)}
.nav-item:active{transform:translateY(-2px)}
.nav-item::after{content:attr(title);position:absolute;bottom:-24px;background:var(--surface);padding:4px 8px;border-radius:8px;color:var(--muted);font-size:12px;opacity:0;transition:opacity var(--transition);pointer-events:none}
.nav-item:hover::after{opacity:1}

/* Install prompt - Animated slide */
.install-prompt{position:fixed;right:18px;bottom:92px;z-index:350;display:flex;gap:12px;align-items:center;background:linear-gradient(90deg,var(--secondary),var(--primary));color:#021;padding:12px;border-radius:12px;font-weight:800;transform:translateY(18px) scale(.98);opacity:0;transition:all 420ms cubic-bezier(.2,.9,.2,1);display:none}
.install-prompt.show{display:flex;transform:translateY(0) scale(1);opacity:1}

/* Ad placeholder - Styled for AdSense */
.ad-placeholder{background:var(--surface);border:1px dashed var(--muted);padding:20px;text-align:center;color:var(--muted);border-radius:var(--radius);margin:12px 0}

/* Responsive tweaks - Better mobile */
@media (max-width:520px){
  .nav-item{width:48px;height:48px}
  .nav-item .icon{width:28px;height:28px}
  header{padding:10px}
  .logo{width:40px;height:40px}
  main{padding:8px;gap:8px}
}
</style>
</head>
<body>

<!-- 3D background canvas - Enhanced performance -->
<canvas id="bgCanvas" style="position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.45"></canvas>

<header>
  <div class="brand">
    <div class="logo" aria-hidden>AG</div>
    <div>
      <div class="header-title">AfroGenstas</div>
      <div class="header-sub">Music • Markets • Gamified</div>
    </div>
  </div>

  <nav id="topNav" aria-label="Main navigation">
    <button data-route="home" class="active">Home</button>
    <button data-route="market">Market</button>
    <button data-route="portfolio">Portfolio</button>
    <button data-route="leaderboard">Leaderboard</button>
    <button data-route="futures">Futures</button>
    <button data-route="macro">Macro</button>
    <button data-route="gallery">Gallery</button>
    <button data-route="insights">AI</button>
  </nav>
</header>

<main>
  <section id="app" class="card" aria-live="polite" style="z-index:20"></section>

  <aside style="z-index:20">
    <div class="card">
      <h3>Live Ticker</h3>
      <div id="ticker" class="ticker muted" aria-live="polite"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Profile</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:62px;height:62px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent));display:grid;place-items:center;font-weight:800;font-family:'Orbitron',sans-serif">U</div>
        <div>
          <div id="userName" style="font-weight:700">Guest</div>
          <div id="userMeta" class="small muted">Lv 1 • XP 0</div>
        </div>
      </div>
      <div style="margin-top:10px" class="controls">
        <button id="btnPremium" class="btn">Go Premium</button>
        <button id="btnExport" class="btn ghost">Export PDF</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Spotlight 3D</h3>
      <div id="spot3d" class="three-wrap">
        <iframe id="spotFrame" class="sketch" src="" title="3D artist spotlight" allow="autoplay; fullscreen; vr"></iframe>
      </div>
      <div class="muted small" style="margin-top:8px">Top artist visual (updates with market leader)</div>
    </div>

    <div class="card ad-placeholder" style="margin-top:12px">
      <h3>Sponsored</h3>
      <!-- AdSense Example (Replace with your code) -->
      <!-- <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-XXXX" data-ad-slot="XXXX" data-ad-format="auto"></ins> -->
      <div>Ad slot — Integrate Google AdSense for revenue</div>
    </div>
  </aside>
</main>

<footer>© 2025 AfroGenstas — Build, play & invest in Afrobeat culture | <a href="#">Terms</a> | <a href="#">Privacy</a></footer>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true" role="dialog">
  <img id="lightboxImg" alt="Artwork" />
</div>

<!-- Install prompt -->
<div id="installPrompt" class="install-prompt" aria-hidden="true">
  <div style="display:flex;flex-direction:column">
    <div style="font-weight:900">Install AfroGenstas</div>
    <div style="font-size:13px;color:#062">Add to home screen for quick access</div>
  </div>
  <div style="margin-left:12px;display:flex;flex-direction:column;gap:6px">
    <button id="installAccept" class="btn">Install</button>
    <button id="installDismiss" class="btn ghost">Later</button>
  </div>
</div>

<!-- Bottom nav -->
<div class="bottom-nav" role="navigation" aria-label="Bottom navigation">
  <div class="nav-item active" data-route="home" title="Home" aria-label="Home">
    <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="7" width="18" height="10" rx="2" fill="url(#g1)" opacity="0.95"></rect></svg>
  </div>
  <div class="nav-item" data-route="market" title="Market" aria-label="Market">
    <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="4" y="6" width="16" height="12" rx="3" fill="url(#g2)"></rect></svg>
  </div>
  <div class="nav-item" data-route="portfolio" title="Portfolio" aria-label="Portfolio">
    <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" fill="rgba(255,255,255,0.02)"></rect></svg>
  </div>
  <div class="nav-item" data-route="leaderboard" title="Leaderboard" aria-label="Leaderboard">
    <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" fill="rgba(255,255,255,0.02)"></rect></svg>
  </div>
  <div class="nav-item" data-route="futures" title="Futures" aria-label="Futures">
    <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" fill="rgba(255,255,255,0.02)"></rect></svg>
  </div>
  <div class="nav-item" data-route="macro" title="Macro" aria-label="Macro">
    <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" fill="rgba(255,255,255,0.02)"></rect></svg>
  </div>
  <div class="nav-item" data-route="gallery" title="Gallery" aria-label="Gallery">
    <svg class="icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" fill="rgba(255,255,255,0.02)"></rect></svg>
  </div>
</div>

<script>
/* ================= AfroGenstas Professional Single-file App =================
   - Expanded features: Futures, Macro Dashboard, Premium tease.
   - Profitable: Ad placeholders, premium upsell.
   - Professional: Error handling, accessibility, responsive.
   - End-to-End: Full trading, levels, AI, PDF, PWA.
   - No secrets in client. Gemini via server or local.
*/

(() => {
  'use strict';

  /* ---------------- CONFIG ---------------- */
  const APP_CONFIG = {
    SERVER_SUMMARIZE_URL: '', // Set to your Gemini endpoint for real AI
    CLIENT_KEY: 'public-demo-key-123',
    VERSION: '3.0.0-professional',
    PREMIUM_FEATURES: false // Simulate subscription
  };

  /* ---------------- DATA (expanded) ---------------- */
  const ARTISTS = [
    { ticker:'$BURNA', name:'Burna Boy', color:'#FF6B00', poster:'https://wallpapercat.com/img/7439749.jpg', cover:'https://images.unsplash.com/photo-1544148106-0c3b8403d5f4?q=80&w=1200&auto=format&fit=crop', sketch:'https://sketchfab.com/models/8208f257d2d3457183e866eb990e6511/embed' },
    { ticker:'$REMA',  name:'Rema',      color:'#00FFD1', poster:'https://wallpapercat.com/img/7439748.jpg', cover:'https://images.unsplash.com/photo-1505685296765-3a2736de412f?q=80&w=1200&auto=format&fit=crop', sketch:'https://sketchfab.com/3d-models/realistic-afrocentric-female-planar-head-08b834d4966747b897e6553fb846562b/embed' },
    { ticker:'$ASAKE', name:'Asake',     color:'#FF2E97', poster:'https://wallpaperaccess.com/full/11067438.jpg', cover:'https://images.unsplash.com/photo-1544717305-2782549b5136?q=80&w=1200&auto=format&fit=crop', sketch:'https://sketchfab.com/models/9f6b0e3f3f374b4b8b4f6a4f/embed' },
    { ticker:'$WIZ', name:'Wizkid', color:'#6c5cff', poster:'https://images.unsplash.com/photo-1614617063063-8c013d9e73b7?q=80&w=1200&auto=format&fit=crop', cover:'https://images.unsplash.com/photo-1559825481-12a05cc96c14?q=80&w=1200&auto=format&fit=crop', sketch:'https://sketchfab.com/models/4f2a3b8f3f2b4e0e9728f2bd1/embed' },
    { ticker:'$OBO', name:'Davido', color:'#ff2e97', poster:'https://images.unsplash.com/photo-1570295993259-0eb4097c26e5?q=80&w=1200&auto=format&fit=crop', cover:'https://images.unsplash.com/photo-1511671783919-16737624e1f4?q=80&w=1200&auto=format&fit=crop', sketch:'https://sketchfab.com/models/8208f257d2d3457183e866eb990e6511/embed' },
    { ticker:'$TIWA', name:'Tiwa Savage', color:'#00ffd1', poster:'https://images.unsplash.com/photo-1544717305-2782549b5136?q=80&w=1200&auto=format&fit=crop', cover:'https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=1200&auto=format&fit=crop', sketch:'https://sketchfab.com/3d-models/realistic-afrocentric-female-planar-head-08b834d4966747b897e6553fb846562b/embed' }
  ];

  const FUTURES = [
    { name:'AfroFire Track', roi:15, confidence:80, countdown:7, invested: false },
    { name:'Naija Vibes Beat', roi:20, confidence:75, countdown:14, invested: false },
    { name:'Lagos Groove Song', roi:18, confidence:85, countdown:5, invested: false }
  ];

  const MACRO_DATA = {
    globalStreams: '5.2B',
    marketShare: { Spotify: 35, YouTube: 20, AppleMusic: 15, Others: 30 },
    topRegion: 'Nigeria: 60%',
    emergingGenre: 'Afro-Fusion: +25%'
  };

  /* ---------------- STATE ---------------- */
  const LS_KEY = 'afrogenstas_prof_v3';
  function defaultProfile(){ return { user:'Guest', xp:0, level:1, streak:0, quests:[], achievements:{}, portfolio:{ cash:15000, holdings:{}, history:[], futures:[] }, premium: false }; }
  let PROFILE = loadProfile();
  let currentRoute = 'home';
  const priceState = {};

  /* ---------------- Helpers ---------------- */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  function saveProfile(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(PROFILE)); }catch(e){ console.warn('save fail', e); } }
  function loadProfile(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || defaultProfile(); }catch(e){ return defaultProfile(); } }
  function nowISO(){ return new Date().toISOString(); }
  function toast(msg, t=2200){ const el = document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); requestAnimationFrame(()=>{el.classList.add('show');}); setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),350); }, t); }
  function hexToRgba(hex, a=0.12){ const c = hex.replace('#',''); const r = parseInt(c.substring(0,2),16), g=parseInt(c.substring(2,4),16), b=parseInt(c.substring(4,6),16); return `rgba(${r},${g},${b},${a})`; }
  function fmt(n){ return '$' + Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function premiumCheck(feature){ if(!PROFILE.premium){ toast('Premium feature - Subscribe now!'); return false; } return true; }

  /* ---------------- Price Simulation - More realistic ---------------- */
  function initPrices(){
    ARTISTS.forEach(a => {
      const base = 50 + Math.random()*180;
      priceState[a.ticker] = { history: Array.from({length:100}, (_,i)=>Math.round((base + Math.sin(i/6)*6 + Math.random()*7)*100)/100), last: Math.round(base*100)/100, popularity: 30 + Math.random()*70 };
    });
    scheduleTick();
  }

  let tickHandle = null;
  function scheduleTick(){
    if(tickHandle) clearTimeout(tickHandle);
    tickPrices();
    tickHandle = setTimeout(scheduleTick, 2600 + Math.random()*1600);
  }

  function tickPrices(){
    ARTISTS.forEach(a => {
      const s = priceState[a.ticker];
      const impulse = (Math.random() < 0.05) ? ( (Math.random()>0.5?1:-1) * (2 + Math.random()*6) ) : 0;
      s.popularity = Math.max(0, Math.min(100, s.popularity + (Math.random()-0.5)*2 + (impulse>0?1:-0.5)));
      const noise = (Math.random()-0.5) * 0.02 + (s.popularity - 50) / 5000;
      s.last = Math.max(0.5, Math.round((s.last * (1 + noise) + impulse) * 100) / 100);
      s.history.push(s.last);
      if(s.history.length>600) s.history.shift();
    });
    renderTicker();
    if(currentRoute === 'market' || currentRoute === 'portfolio' || currentRoute === 'futures') navigate(currentRoute);
    updateSpotlightFrame();
  }

  /* ---------------- 3D Background - Optimized with particles ---------------- */
  function init3DBackground(){
    try{
      const canvas = $('#bgCanvas');
      const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 1000);
      camera.position.set(0,0,70);

      const knotGeo = new THREE.TorusKnotGeometry(12, 1.4, 180, 24);
      const knotMat = new THREE.MeshStandardMaterial({ color: 0x7c5cff, roughness:0.5, metalness:0.12, emissive:0x2b1b6b, emissiveIntensity:0.12 });
      const knot = new THREE.Mesh(knotGeo, knotMat);
      knot.rotation.x = 0.6; scene.add(knot);

      const pCount = 500;
      const positions = new Float32Array(pCount*3);
      for(let i=0;i<pCount;i++){ positions[i*3+0]=(Math.random()-0.5)*400; positions[i*3+1]=(Math.random()-0.5)*120; positions[i*3+2]=(Math.random()-0.5)*400; }
      const particleGeo = new THREE.BufferGeometry();
      particleGeo.setAttribute('position', new THREE.BufferAttribute(positions,3));
      const particleMat = new THREE.PointsMaterial({ color:0x00e5ff, size:0.5, transparent:true, opacity:0.12 });
      const particles = new THREE.Points(particleGeo, particleMat);
      scene.add(particles);

      const amb = new THREE.AmbientLight(0xffffff, 0.12); scene.add(amb);
      const dir = new THREE.DirectionalLight(0xffffff, 0.18); dir.position.set(50,50,100); scene.add(dir);

      function resize(){ renderer.setSize(innerWidth, innerHeight); camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); }
      resize(); window.addEventListener('resize', resize);

      let t=0;
      (function loop(){
        t += 0.006;
        const beat = (Math.sin(t*3.5) + 1) * 0.5;
        knot.rotation.y += 0.002 + 0.001 * beat;
        knot.rotation.x += 0.0008;
        knot.scale.setScalar(1 + 0.02 * beat);
        particles.rotation.y = -t*0.02;
        knot.material.emissiveIntensity = 0.08 + marketMoodNormalized() * 0.4;
        renderer.render(scene, camera);
        requestAnimationFrame(loop);
      })();

      return true;
    }catch(e){ console.warn('3D failed', e); return false; }
  }

  function marketMoodNormalized(){
    let score=0; ARTISTS.forEach(a => { const s = priceState[a.ticker]; const h = s.history; const prev = h[h.length-2] || h[0]; score += Math.sign(s.last - prev) * Math.min(1, Math.abs((s.last - prev) / Math.max(1, prev))); });
    return Math.max(0, Math.min(1, (score / ARTISTS.length + 1)/2));
  }

  /* ---------------- ROUTING - Expanded ---------------- */
  const ROUTES = { home: renderHome, market: renderMarket, portfolio: renderPortfolio, leaderboard: renderLeaderboard, futures: renderFutures, macro: renderMacro, gallery: renderGallery, insights: renderInsights };
  function initNav(){
    $$('#topNav button').forEach(b => b.addEventListener('click', navHandler));
    $$('.bottom-nav .nav-item').forEach(n => n.addEventListener('click', navHandler));
    function navHandler(e){
      const route = e.currentTarget.dataset.route;
      $$('#topNav button').forEach(x=>x.classList.toggle('active', x.dataset.route === route));
      $$('.bottom-nav .nav-item').forEach(x=>x.classList.toggle('active', x.dataset.route === route));
      navigate(route);
    }
    window.addEventListener('popstate', () => { const r = location.hash.replace('#','') || 'home'; navigate(r, true); });
  }
  function navigate(route, fromPop=false){
    currentRoute = route || 'home';
    if(!fromPop) history.pushState({route}, '', '#'+route);
    (ROUTES[route] || ROUTES.home)();
  }

  /* ---------------- RENDERERS - Enhanced ---------------- */

  // Home - Featured content
  function renderHome(){
    const app = $('#app');
    app.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h1>AfroGenstas</h1>
          <div class="muted">Invest in Afrobeat artists like stocks. Track portfolios, compete, and get AI insights.</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="openMarket" class="btn">Open Market</button>
          <button id="openPortfolio" class="btn ghost">Portfolio</button>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h2>Top Artists</h2>
        <div id="topArtists" class="grid-cards" style="margin-top:10px"></div>
      </div>

      <div style="margin-top:12px" class="card ad-placeholder">
        <!-- AdSense Horizontal -->
        <div>Featured Ad — Monetize with targeted ads</div>
      </div>
    `;
    $('#openMarket').addEventListener('click', ()=> navigate('market'));
    $('#openPortfolio').addEventListener('click', ()=> navigate('portfolio'));

    const grid = $('#topArtists'); grid.innerHTML = '';
    ARTISTS.forEach(a => {
      const s = priceState[a.ticker];
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<div style="display:flex;gap:12px">
        <div style="width:84px;height:84px;border-radius:12px;overflow:hidden"><img src="${a.poster}" alt="${a.name} poster" loading="lazy"></div>
        <div style="flex:1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${a.name}</strong><div class="small muted">${a.ticker}</div></div>
            <div style="text-align:right"><div style="font-weight:900">${s.last.toFixed(2)}</div><div class="small muted">Pop ${s.popularity.toFixed(0)}</div></div>
          </div>
          <div style="margin-top:8px" class="controls"><button class="btn" data-buy="${a.ticker}">Buy</button><button class="btn ghost" data-view="${a.ticker}">View</button></div>
        </div>
      </div>`;
      grid.appendChild(card);
      card.querySelector('[data-buy]').addEventListener('click', () => openTradeModal('BUY', a.ticker));
      card.querySelector('[data-view]').addEventListener('click', () => openArtistPanel(a.ticker));
    });
  }

  // Market - Interactive chart
  let marketChart = null;
  function renderMarket(){
    const app = $('#app');
    app.innerHTML = `
      <h2>Artist Stock Market</h2>
      <div class="muted">Buy/sell artists based on streaming metrics</div>

      <div style="margin-top:12px" class="card">
        <h3>Artists</h3>
        <table class="table"><thead><tr><th>Artist</th><th>Ticker</th><th>Price</th><th>Change</th><th>Popularity</th><th>Action</th></tr></thead><tbody id="marketBody"></tbody></table>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Price Chart</h3>
        <canvas id="marketChart" style="height:200px"></canvas>
        <div style="margin-top:8px" class="controls">
          <select id="artistSelect" class="input">${ARTISTS.map(a=>`<option value="${a.ticker}">${a.ticker} — ${a.name}</option>`).join('')}</select>
          <button id="viewSeries" class="btn ghost">Update Chart</button>
        </div>
      </div>
    `;
    renderMarketBody();
    $('#viewSeries').addEventListener('click', ()=> drawMarketChart($('#artistSelect').value));
    drawMarketChart(ARTISTS[0].ticker);
  }

  function renderMarketBody(){
    const tbody = $('#marketBody'); if(!tbody) return; tbody.innerHTML='';
    ARTISTS.forEach(a => {
      const s = priceState[a.ticker]; const prev = s.history[s.history.length-2] || s.last; const change = ((s.last - prev)/prev*100).toFixed(2);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.name}</td><td>${a.ticker}</td><td style="font-weight:800">${s.last.toFixed(2)}</td><td style="color:${change >= 0 ? var(--success) : var(--danger)}">${change >= 0 ? '+' : ''}${change}%</td><td>${s.popularity.toFixed(0)}</td><td><div class="controls"><button class="btn" data-buy="${a.ticker}">Buy</button><button class="btn ghost" data-sell="${a.ticker}">Sell</button></div></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('[data-buy]').forEach(b => b.addEventListener('click', e => openTradeModal('BUY', e.currentTarget.dataset.buy)));
    tbody.querySelectorAll('[data-sell]').forEach(b => b.addEventListener('click', e => openTradeModal('SELL', e.currentTarget.dataset.sell)));
  }

  function drawMarketChart(ticker){
    const ctx = $('#marketChart').getContext('2d');
    const s = priceState[ticker]; const series = s.history.slice(-200);
    if(marketChart) marketChart.destroy();
    marketChart = new Chart(ctx, {
      type:'line',
      data:{ labels: series.map((_,i)=>i), datasets:[{ label: ticker, data: series, borderColor: ARTISTS.find(a=>a.ticker===ticker).color, backgroundColor: hexToRgba(ARTISTS.find(a=>a.ticker===ticker).color, .12), fill:true, tension:0.28 }]},
      options:{plugins:{legend:{display:true, position:'top'}}, scales:{x:{display:false}, y:{beginAtZero:false}}}
    });
  }

  // Artist panel - Detailed view
  function openArtistPanel(ticker){
    const artist = ARTISTS.find(a => a.ticker === ticker); if(!artist) return toast('Artist not found');
    const s = priceState[ticker];
    const app = $('#app');
    app.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h2>${artist.name} <small class="muted">${artist.ticker}</small></h2><div class="small muted">Last ${s.last.toFixed(2)} • Change ${((s.last - s.history[s.history.length-2]||s.last)/s.last*100).toFixed(2)}% • Pop ${s.popularity.toFixed(0)}</div></div>
        <div><button id="backToMarket" class="btn ghost">Back</button></div>
      </div>
      <div style="margin-top:12px" class="card">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1"><canvas id="artistChart" style="height:180px"></canvas></div>
          <div style="width:260px">
            <div style="height:160px;border-radius:12px;overflow:hidden"><img src="${artist.cover}" alt="${artist.name} cover" loading="lazy"></div>
            <div style="margin-top:8px" class="controls"><button id="tradeArtist" class="btn">Trade</button><button id="summBtn" class="btn ghost">AI Insight</button></div>
            <div id="artistInfo" class="muted small" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    `;
    $('#backToMarket').addEventListener('click', ()=> navigate('market'));
    $('#tradeArtist').addEventListener('click', ()=> openTradeModal('BUY', ticker));
    $('#summBtn').addEventListener('click', async () => {
      const info = $('#artistInfo'); info.textContent='Generating…';
      try{ const out = await summarize(`Provide trading insight for ${artist.name}: current price ${s.last}, popularity ${s.popularity}, recent change.`); info.innerHTML = out.replace(/\n/g,'<br/>'); }catch(e){ info.textContent = 'AI error: ' + e.message; }
    });

    const ctx = $('#artistChart').getContext('2d');
    const series = s.history.slice(-200);
    new Chart(ctx, { type:'line', data:{ labels: series.map((_,i)=>i), datasets:[{ data: series, borderColor: artist.color, backgroundColor: hexToRgba(artist.color, .12), fill:true, tension:0.28 }]}, options:{plugins:{legend:{display:false}}, scales:{x:{display:false}}} });
  }

  // Trade modal - Quantity validation
  function openTradeModal(side='BUY', ticker=null){
    const modal = document.createElement('div'); modal.className='card'; modal.style.marginBottom='12px'; modal.setAttribute('role', 'dialog');
    modal.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h3>${side} ${ticker||'Artist'}</h3><div class="small muted">Enter details</div></div>
        <div><button class="btn ghost close">Close</button></div>
      </div>
      <div style="margin-top:12px" class="controls">
        <select id="trTicker" class="input">${ARTISTS.map(a=>`<option value="${a.ticker}" ${a.ticker===ticker?'selected':''}>${a.ticker} — ${a.name}</option>`).join('')}</select>
        <input id="trQty" type="number" min="1" value="1" class="input" style="width:110px"/>
        <button id="trConfirm" class="btn">${side}</button>
      </div>
      <div id="trPreview" class="muted small" style="margin-top:8px"></div>
    `;
    $('#app').prepend(modal);
    modal.querySelector('.close').addEventListener('click', ()=> modal.remove());
    const preview = modal.querySelector('#trPreview');
    const updatePreview = ()=>{ const t=modal.querySelector('#trTicker').value; const q=Math.max(1,parseInt(modal.querySelector('#trQty').value)||1); const price = priceState[t].last; preview.innerHTML = `Price: <strong>${price.toFixed(2)}</strong> • Total: <strong>${(price*q).toFixed(2)}</strong>`; };
    modal.querySelector('#trTicker').addEventListener('change', updatePreview);
    modal.querySelector('#trQty').addEventListener('input', updatePreview);
    updatePreview();
    modal.querySelector('#trConfirm').addEventListener('click', () => { const t = modal.querySelector('#trTicker').value; const q = Math.max(1,parseInt(modal.querySelector('#trQty').value)||1); executeTrade(side,t,q); modal.remove(); });
  }

  // Execute trade - With fees for realism
  function executeTrade(side, ticker, qty){
    const price = priceState[ticker].last;
    const fee = 0.001 * price * qty; // 0.1% fee
    if(side === 'BUY'){
      const cost = (price * qty) + fee;
      if(cost > PROFILE.portfolio.cash){ toast('Insufficient cash'); return; }
      const hold = PROFILE.portfolio.holdings[ticker] || { qty:0, avg:0 };
      const newQty = hold.qty + qty;
      const newAvg = ((hold.avg*hold.qty) + price*qty) / newQty;
      PROFILE.portfolio.holdings[ticker] = { qty:newQty, avg:newAvg };
      PROFILE.portfolio.cash -= cost;
      PROFILE.portfolio.history.push({ t: nowISO(), action:'BUY', ticker, qty, price, fee });
      PROFILE.xp += Math.max(6, Math.round(qty*0.6));
      toast(`Bought ${qty} ${ticker} (Fee: ${fee.toFixed(2)})`);
    } else {
      const hold = PROFILE.portfolio.holdings[ticker];
      if(!hold || hold.qty < qty){ toast('Insufficient holdings'); return; }
      hold.qty -= qty; if(hold.qty === 0) delete PROFILE.portfolio.holdings[ticker];
      PROFILE.portfolio.cash += (qty * price) - fee;
      PROFILE.portfolio.history.push({ t: nowISO(), action:'SELL', ticker, qty, price, fee });
      PROFILE.xp += Math.max(4, Math.round(qty*0.3));
      toast(`Sold ${qty} ${ticker} (Fee: ${fee.toFixed(2)})`);
    }
    levelCheck(); saveProfile(); updateSnapshot();
    if(currentRoute === 'portfolio') renderPortfolio();
  }

  // Level & XP - Achievements
  function levelCheck(){
    let target = 100 + (PROFILE.level - 1) * 75;
    while(PROFILE.xp >= target){
      PROFILE.xp -= target; PROFILE.level += 1; PROFILE.achievements[`level_${PROFILE.level}`] = { at: nowISO() }; toast(`Level up! Lv ${PROFILE.level}`); target = 100 + (PROFILE.level - 1) * 75;
    }
    updateProfileUI();
  }

  // Portfolio - Advanced metrics
  let portfolioChart = null;
  function renderPortfolio(){
    const app = $('#app');
    app.innerHTML = `
      <h2>Your Portfolio</h2>
      <div class="muted">Track performance and holdings</div>

      <div style="margin-top:12px" class="card">
        <h3>Holdings</h3>
        <table class="table"><thead><tr><th>Artist</th><th>Ticker</th><th>Qty</th><th>Avg Cost</th><th>Current</th><th>Value</th><th>P/L</th><th>Action</th></tr></thead><tbody id="holdingsTbl"></tbody></table>
        <div style="margin-top:10px" class="muted">Cash: <strong id="cashVal"></strong> • Total Equity: <strong id="totalVal"></strong></div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Performance Chart</h3>
        <canvas id="portfolioChart" style="height:200px"></canvas>
        <div id="portfolioMetrics" class="muted" style="margin-top:8px"></div>
      </div>

      <div class="ad-placeholder" style="margin-top:12px">
        <div>Portfolio Ad — Earn from user engagement</div>
      </div>
    `;
    updateHoldingsUI(); drawPortfolioChart();
  }

  function updateHoldingsUI(){
    const tbody = $('#holdingsTbl'); if(!tbody) return; tbody.innerHTML='';
    let equity = 0;
    for(const [t,h] of Object.entries(PROFILE.portfolio.holdings)){
      const art = ARTISTS.find(a=>a.ticker===t) || { name: t };
      const last = priceState[t].last; const value = last * h.qty; equity += value;
      const pl = (last - h.avg) * h.qty;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${art.name}</td><td>${t}</td><td>${h.qty}</td><td>${h.avg.toFixed(2)}</td><td>${last.toFixed(2)}</td><td>${value.toFixed(2)}</td><td style="color:${pl>=0? var(--success):var(--danger)}">${pl>=0?'+':''}${pl.toFixed(2)}</td><td><button class="btn ghost" data-sell="${t}">Sell</button></td>`;
      tbody.appendChild(tr);
    }
    tbody.querySelectorAll('[data-sell]').forEach(b => b.addEventListener('click', e => openTradeModal('SELL', e.currentTarget.dataset.sell)));
    const total = equity + PROFILE.portfolio.cash;
    $('#cashVal').textContent = fmt(PROFILE.portfolio.cash);
    $('#totalVal').textContent = fmt(total);
    updateSnapshot(); saveProfile();
  }

  function getPortfolioSeries(){
    const len = 64; const series = [];
    for(let i=0;i<len;i++){
      let tot = PROFILE.portfolio.cash;
      for(const [t,h] of Object.entries(PROFILE.portfolio.holdings)){
        const hist = priceState[t].history; const idx = Math.max(0, hist.length - len + i);
        tot += (hist[idx] || hist[0] || 100) * h.qty;
      }
      series.push(tot);
    }
    return series;
  }

  function drawPortfolioChart(){
    const canvas = $('#portfolioChart'); if(!canvas) return;
    const series = getPortfolioSeries();
    if(portfolioChart) portfolioChart.destroy();
    portfolioChart = new Chart(canvas.getContext('2d'), { type:'line', data:{ labels: series.map((_,i)=>i), datasets:[{ label: 'Portfolio Value', data: series, borderColor:'#6c5cff', backgroundColor: hexToRgba('#6c5cff', .12), fill:true }]}, options:{plugins:{legend:{display:true}}, scales:{x:{display:false}}} });
    const metrics = computeMetrics(series);
    $('#portfolioMetrics').innerHTML = `Annual Return: <strong>${(metrics.annual_return*100).toFixed(2)}%</strong> • Volatility: <strong>${(metrics.volatility_ann*100).toFixed(2)}%</strong> • Sharpe Ratio: <strong>${metrics.sharpe.toFixed(2)}</strong>`;
  }

  // Leaderboard - Dynamic with user
  let LEADERBOARD = [ { user:'Keita', value:32200, premium:true }, { user:'Aisha', value:27140, premium:false }, { user:'Tunde', value:19870, premium:true }, { user:'You', value:0, premium:PROFILE.premium } ];
  function renderLeaderboard(){
    const app = $('#app'); app.innerHTML = `<h2>Global Leaderboard</h2><div class="muted">Top portfolios by value</div><div style="margin-top:12px" id="lbWrap"></div>`;
    const wrap = $('#lbWrap'); wrap.innerHTML = '';
    LEADERBOARD.sort((a,b)=>b.value-a.value);
    LEADERBOARD.forEach((p,i) => {
      const c = document.createElement('div'); c.className='card';
      c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${i+1}. ${p.user}</strong>${p.premium ? '<span class="small" style="color:var(--primary)"> Premium</span>' : ''}<div class="small muted">Value</div></div><div style="font-weight:900">${fmt(p.value)}</div></div>`;
      wrap.appendChild(c);
    });
  }

  // Futures - Investment simulation
  function renderFutures(){
    const app = $('#app'); app.innerHTML = `<h2>Song & Beat Futures</h2><div class="muted">Invest in pre-releases for ROI</div><div style="margin-top:12px" class="grid-cards" id="futuresGrid"></div>`;
    const grid = $('#futuresGrid'); grid.innerHTML = '';
    FUTURES.forEach((f,i) => {
      const card = document.createElement('div'); card.className='card';
      card.innerHTML = `<h3>${f.name}</h3><div class="muted">Projected ROI: ${f.roi}% • Confidence: ${f.confidence}% • Countdown: ${f.countdown} days</div><div style="margin-top:8px" class="controls"><button class="btn" data-invest="${i}" ${f.invested ? 'disabled' : ''}>${f.invested ? 'Invested' : 'Invest $1000'}</button></div>`;
      grid.appendChild(card);
      if(!f.invested) card.querySelector('[data-invest]').addEventListener('click', () => investFuture(i));
    });
  }

  function investFuture(index){
    if(PROFILE.portfolio.cash < 1000){ toast('Insufficient cash for investment'); return; }
    PROFILE.portfolio.cash -= 1000;
    FUTURES[index].invested = true;
    PROFILE.portfolio.futures.push({ ...FUTURES[index], investedAt: nowISO(), amount:1000 });
    PROFILE.xp += 20;
    toast(`Invested in ${FUTURES[index].name}`);
    levelCheck(); saveProfile(); renderFutures(); if(currentRoute === 'portfolio') renderPortfolio();
  }

  // Macro Dashboard - Charts and stats
  let macroChart = null;
  function renderMacro(){
    const app = $('#app'); app.innerHTML = `<h2>Afrobeat Macro Dashboard</h2><div class="muted">Industry trends and metrics</div>
      <div style="margin-top:12px" class="grid-cards">
        <div class="card"><h3>Global Streams</h3><div style="font-size:24px;font-weight:800">${MACRO_DATA.globalStreams}</div></div>
        <div class="card"><h3>Top Region</h3><div style="font-size:24px;font-weight:800">${MACRO_DATA.topRegion}</div></div>
        <div class="card"><h3>Emerging Genre</h3><div style="font-size:24px;font-weight:800">${MACRO_DATA.emergingGenre}</div></div>
      </div>
      <div style="margin-top:12px" class="card">
        <h3>Market Share</h3>
        <canvas id="macroChart" style="height:200px"></canvas>
      </div>`;
    drawMacroChart();
  }

  function drawMacroChart(){
    const ctx = $('#macroChart').getContext('2d');
    if(macroChart) macroChart.destroy();
    macroChart = new Chart(ctx, {
      type:'pie',
      data:{
        labels: Object.keys(MACRO_DATA.marketShare),
        datasets:[{ data: Object.values(MACRO_DATA.marketShare), backgroundColor: ['#1db954', '#ff0000', '#fa57c1', '#6c5cff'] }]
      },
      options:{plugins:{legend:{position:'bottom'}}}
    });
  }

  // Gallery - Expanded with more images
  function renderGallery(){
    const app = $('#app'); app.innerHTML = `<h2>Gallery</h2><div class="muted">Artist posters and album art</div><div style="margin-top:12px" class="card"><div class="grid-cards" id="galleryGrid"></div></div>`;
    const g = $('#galleryGrid'); g.innerHTML = '';
    ARTISTS.forEach(a => { 
      const d = document.createElement('div'); d.className='poster'; d.innerHTML = `<img src="${a.poster}" alt="${a.name} poster" loading="lazy">`; g.appendChild(d); d.addEventListener('click', ()=> openLightbox(a.poster));
      const c = document.createElement('div'); c.className='poster'; c.innerHTML = `<img src="${a.cover}" alt="${a.name} cover" loading="lazy">`; g.appendChild(c); c.addEventListener('click', ()=> openLightbox(a.cover));
    });
  }

  // Insights - Enhanced AI with premium
  function renderInsights(){
    const app = $('#app'); app.innerHTML = `<h2>AI-Powered Insights</h2><div class="muted">Generate reports and predictions${PROFILE.premium ? '' : ' (Premium for advanced)'}</div><div style="margin-top:12px" class="card"><textarea id="aiText" rows="6" class="input" placeholder="Enter query or paste text..."></textarea><div style="margin-top:8px" class="controls"><button id="genAI" class="btn">Generate Insight</button></div><div id="aiOut" class="muted" style="margin-top:8px"></div></div>`;
    $('#genAI').addEventListener('click', async () => {
      const t = $('#aiText').value.trim(); if(!t) return toast('Enter a query');
      if(!premiumCheck('AI')) return;
      $('#aiOut').textContent = 'Generating…';
      try{ const out = await summarize(t); $('#aiOut').innerHTML = out.replace(/\n/g,'<br/>'); }catch(e){ $('#aiOut').textContent = 'AI error: ' + e.message; }
    });
  }

  // Summarize - Gemini simulation
  async function summarize(text){
    if(!APP_CONFIG.SERVER_SUMMARIZE_URL) return localSummarize(text);
    const res = await fetch(APP_CONFIG.SERVER_SUMMARIZE_URL, { method:'POST', headers:{ 'Content-Type':'application/json', 'x-client-key': APP_CONFIG.CLIENT_KEY }, body: JSON.stringify({ text }) });
    if(!res.ok) throw new Error(await res.text() || res.statusText);
    const j = await res.json(); return j.summary || '';
  }
  function localSummarize(text){ 
    // Enhanced local fallback with Gemini-like output
    return `AI Insight (Local Simulation):\n\n- Summary: ${text.slice(0,100)}...\n- Recommendation: Buy if popularity > 50, Sell otherwise.\n- Predicted Breakout: 20% chance.`; 
  }

  // PDF export - Detailed report
  async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    doc.setFontSize(16); doc.text("AfroGenstas Professional Report", 40, 60);
    doc.setFontSize(11); doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);
    doc.text(`User: ${PROFILE.user} (Level ${PROFILE.level})`, 40, 98); doc.text(`Cash: ${fmt(PROFILE.portfolio.cash)}`, 40, 116);
    let y=140; doc.text("Holdings:", 40, y); y+=14;
    for(const [t,h] of Object.entries(PROFILE.portfolio.holdings)){
      const last = priceState[t].last; doc.text(`${t} • Qty: ${h.qty} • Avg: ${h.avg.toFixed(2)} • Last: ${last.toFixed(2)} • Value: ${(last*h.qty).toFixed(2)}`, 48, y);
      y += 12; if(y>720){ doc.addPage(); y=40; }
    }
    y += 20; doc.text("Futures Investments:", 40, y); y+=14;
    PROFILE.portfolio.futures.forEach(f => {
      doc.text(`${f.name} • Amount: ${fmt(f.amount)} • Projected ROI: ${f.roi}%`, 48, y);
      y += 12; if(y>720){ doc.addPage(); y=40; }
    });
    doc.save(`afrogenstas-report-${Date.now()}.pdf`);
  }

  /* ---------------- Utilities ---------------- */
  function computeMetrics(series){
    if(series.length < 2) return { annual_return:0, volatility_ann:0, sharpe:0 };
    const rets = series.slice(1).map((v,i) => (v - series[i]) / series[i]);
    const mean = rets.reduce((a,b)=>a+b,0)/rets.length;
    const variance = rets.reduce((a,b)=>a + Math.pow(b - mean, 2),0) / (rets.length - 1);
    const sd = Math.sqrt(variance); const volAnn = sd * Math.sqrt(252); const ann = mean * 252;
    return { annual_return: ann, volatility_ann: volAnn, sharpe: volAnn > 0 ? ann / volAnn : 0 };
  }

  // Lightbox - Improved
  function openLightbox(src){ $('#lightboxImg').src = src; $('#lightbox').classList.add('show'); $('#lightbox').setAttribute('aria-hidden','false'); }
  $('#lightbox')?.addEventListener('click', (e) => { if(e.target === $('#lightbox')) { $('#lightbox').classList.remove('show'); $('#lightbox').setAttribute('aria-hidden','true'); } });

  // Update ticker and spotlight
  function renderTicker(){
    const el = $('#ticker'); if(!el) return; el.innerHTML = '';
    ARTISTS.forEach(a => {
      const s = priceState[a.ticker]; const prev = s.history[s.history.length-2] || s.last; const pct = ((s.last - prev)/prev*100).toFixed(2);
      const d = document.createElement('div'); d.className='tick';
      d.innerHTML = `<div><div style="font-weight:800">${a.ticker}</div><div class="small muted">${a.name}</div></div><div style="text-align:right"><div style="font-weight:900">${s.last.toFixed(2)}</div><div class="small muted" style="color:${pct>=0? var(--success):var(--danger)}">${pct>=0?'+':''}${pct}%</div></div>`;
      el.appendChild(d);
    });
  }

  function updateSpotlightFrame(){
    const top = getTopArtist(); if(!top) return; $('#spotFrame').src = top.sketch || '';
  }
  function getTopArtist(){ let best=null, bestScore=-Infinity; ARTISTS.forEach(a => { const s = priceState[a.ticker]; const score = s.last * (1 + s.popularity/100); if(score > bestScore){ bestScore = score; best = a; } }); return best; }

  // Snapshot / leaderboard update
  function updateSnapshot(){
    let equity=0; for(const [t,h] of Object.entries(PROFILE.portfolio.holdings)) equity += priceState[t].last * h.qty;
    equity += PROFILE.portfolio.futures.reduce((sum, f) => sum + f.amount * (1 + f.roi/100 * (Math.random() * 0.2 + 0.9)), 0); // Simulate ROI
    const total = PROFILE.portfolio.cash + equity;
    const you = LEADERBOARD.find(x => x.user==='You'); you.value = Math.round(total);
  }

  /* ---------------- Install prompt ---------------- */
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferredPrompt = e;
    const p = $('#installPrompt'); p.classList.add('show');
    setTimeout(()=>{ p.classList.remove('show'); }, 10000);
  });
  $('#installAccept')?.addEventListener('click', async ()=>{
    $('#installPrompt').classList.remove('show');
    if(deferredPrompt){ deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; toast(choice.outcome==='accepted' ? 'Installed!' : 'Dismissed'); deferredPrompt=null; }
  });
  $('#installDismiss')?.addEventListener('click', ()=> { $('#installPrompt').classList.remove('show'); });

  /* ---------------- Runtime SW & Manifest ---------------- */
  async function registerRuntimeSW(){
    if('serviceWorker' in navigator){
      const swCode = `
        const CACHE='afrogenstas-v3';
        self.addEventListener('install', e=> self.skipWaiting());
        self.addEventListener('activate', e=> self.clients.claim());
        self.addEventListener('fetch', e=> {
          if(e.request.method !== 'GET') return;
          e.respondWith(caches.open(CACHE).then(cache => fetch(e.request).then(res => { cache.put(e.request, res.clone()); return res; }).catch(() => cache.match(e.request))));
        });
      `;
      const blob = new Blob([swCode], { type:'text/javascript' }); const url = URL.createObjectURL(blob);
      try{ await navigator.serviceWorker.register(url); }catch(e){ console.warn('SW fail', e); }
    }
  }
  function createManifest(){
    const manifest = { name:'AfroGenstas', short_name:'AfroGenstas', start_url:'.', display:'standalone', background_color:'#07060A', theme_color:'#FF6B00', icons:[{src:'https://api.dicebear.com/6.x/shapes/svg?seed=afrogenstas',sizes:'192x192',type:'image/svg+xml',purpose:'any maskable'}] };
    const blob = new Blob([JSON.stringify(manifest)], { type:'application/json' }); const url = URL.createObjectURL(blob);
    let link = document.querySelector('link[rel="manifest"]') || document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
  }

  /* ---------------- Profile UI ---------------- */
  function updateProfileUI(){
    $('#userName').textContent = PROFILE.user;
    $('#userMeta').textContent = `Lv ${PROFILE.level} • XP ${PROFILE.xp}`;
  }

  /* ---------------- Premium ---------------- */
  $('#btnPremium')?.addEventListener('click', () => {
    toast('Upgrade to Premium for advanced AI, no ads, and higher limits! (Simulation: $4.99/mo)');
    PROFILE.premium = true; saveProfile(); updateProfileUI();
  });

  /* ---------------- Boot ---------------- */
  function boot(){
    initNav();
    createManifest();
    registerRuntimeSW();
    init3DBackground();
    initPrices();
    updateProfileUI();
    navigate(location.hash.replace('#','') || 'home');
    $('#btnExport').addEventListener('click', exportPDF);
    setTimeout(()=> { renderTicker(); updateSpotlightFrame(); updateSnapshot(); }, 600);
    // Prompt for username if guest
    if(PROFILE.user === 'Guest') setTimeout(() => { const name = prompt('Enter your username:'); if(name) { PROFILE.user = name; saveProfile(); updateProfileUI(); } }, 2000);
  }

  boot();

})();
</script>
</body>
</html>
