<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>AfroGenstas â€” Music Meets Finance </title>

<!-- Libraries (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* ================= Mobile-first design system ================= */
:root{
  --bg:#04050a; --panel:#071022; --muted:#9aa9bf;
  --accent1:#FF7F50; --accent2:#7C5CFF; --glass: rgba(255,255,255,0.03);
  --card: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.008));
  --radius:14px; --maxW:1100px; --ui-sz:14px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#eaf2ff;background: radial-gradient(700px 360px at 8% 10%, rgba(124,92,255,0.03), transparent), var(--bg)}
a{color:inherit}
header{
  position:sticky; top:0; z-index:120; display:flex; align-items:center; justify-content:space-between;
  padding:12px 14px; background:linear-gradient(180deg, rgba(2,4,10,0.6), rgba(2,4,10,0.2)); border-bottom:1px solid rgba(255,255,255,0.03);
  backdrop-filter: blur(6px);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-items:center;font-weight:900;color:#021;box-shadow:0 6px 28px rgba(124,92,255,0.08)}
.title{font-weight:800;line-height:1}
.subtitle{color:var(--muted);font-size:.85rem}

nav{display:flex;gap:8px;align-items:center}
nav button{background:transparent;border:none;color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700;font-size:.92rem}
nav button.active{color:#fff;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01))}

main{max-width:var(--maxW);margin:12px auto;padding:12px;display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:1000px){ main{grid-template-columns: 720px 1fr } }

.card{background:var(--card); border:1px solid rgba(255,255,255,0.03); padding:14px; border-radius:var(--radius); box-shadow:0 10px 40px rgba(2,6,23,0.5)}
.muted{color:var(--muted);font-size:.95rem}
.hero{display:flex;flex-direction:column;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(124,92,255,0.04), rgba(255,127,80,0.02))}
.kv{display:flex;gap:10px;align-items:center}

.ticker{display:flex;gap:8px;overflow-x:auto;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);white-space:nowrap}
.tick{min-width:140px;padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);display:flex;justify-content:space-between;gap:8px;align-items:center}

.grid-cards{display:grid;gap:12px}
@media(min-width:680px){ .grid-cards{grid-template-columns:repeat(2,1fr)} }

.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
.table th{color:var(--accent1);font-weight:700}

.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.input{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
.btn{background:linear-gradient(90deg,var(--accent2),var(--accent1));border:none;padding:10px 12px;border-radius:12px;color:#021;font-weight:800;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}

.poster{width:120px;height:120px;border-radius:12px;overflow:hidden;flex:0 0 auto;cursor:pointer}
.poster img{width:100%;height:100%;object-fit:cover}

.lightbox{position:fixed;inset:0;background:rgba(2,2,6,0.85);display:none;place-items:center;z-index:220}
.lightbox img{max-width:92%;max-height:86%;border-radius:12px;box-shadow:0 20px 80px rgba(0,0,0,0.8)}

footer{padding:12px;text-align:center;color:var(--muted);font-size:.9rem;margin-top:8px}

.toast{position:fixed;right:16px;bottom:80px;background:linear-gradient(90deg,var(--accent2),var(--accent1));padding:10px 14px;border-radius:12px;color:#021;font-weight:800;z-index:300;transform:translateY(30px);opacity:0;transition:all .32s ease}

/* ================= Bottom 3D nav ================= */
.bottom-nav{
  position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:300; display:flex; gap:10px;
  background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:8px; border-radius:999px; border:1px solid rgba(255,255,255,0.04);
  box-shadow:0 16px 40px rgba(3,6,20,0.6);
}
.nav-item{width:56px;height:56px;border-radius:14px;display:grid;place-items:center;cursor:pointer;backdrop-filter: blur(6px);transition:transform .22s ease, box-shadow .22s}
.nav-item .icon{width:36px;height:36px;filter:drop-shadow(0 6px 18px rgba(124,92,255,0.08));transition:transform .2s}
.nav-item.active{transform:translateY(-6px)}
.nav-item .label{display:none}

/* 3D-like icon using SVG bevel and gradient */
.svg-3d{filter: drop-shadow(0 8px 18px rgba(0,0,0,0.5)); transform-style:preserve-3d}

/* Install prompt (animated) */
.install-prompt{
  position:fixed; right:18px; bottom:92px; z-index:320; display:flex; gap:10px; align-items:center;
  background:linear-gradient(90deg,var(--accent2),var(--accent1)); color:#021; padding:12px;border-radius:12px; font-weight:800; box-shadow:0 20px 40px rgba(0,0,0,0.5);
  transform:translateY(24px) scale(.98); opacity:0; transition:all .45s cubic-bezier(.2,.9,.2,1);
}
.install-prompt.show{ transform:translateY(0) scale(1); opacity:1; }

/* small screens tweak */
@media (max-width:520px){
  .nav-item{width:48px;height:48px}
  .nav-item .icon{width:28px;height:28px}
  header{padding:10px}
  .logo{width:40px;height:40px}
}
</style>
</head>
<body>

<!-- 3D animated background canvas -->
<canvas id="bgCanvas" style="position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.45"></canvas>

<header>
  <div class="brand">
    <div class="logo" aria-hidden>AG</div>
    <div>
      <div class="title">AfroGenstas</div>
      <div class="subtitle muted">Music â€¢ Markets â€¢ Play</div>
    </div>
  </div>

  <nav id="topNav" aria-label="Main navigation">
    <button data-route="home" class="active">Home</button>
    <button data-route="market">Market</button>
    <button data-route="portfolio">Portfolio</button>
    <button data-route="leaderboard">Leaderboard</button>
    <button data-route="gallery">Gallery</button>
    <button data-route="insights">AI</button>
  </nav>
</header>

<main>
  <section id="app" class="card" style="z-index:20"></section>

  <aside style="z-index:20">
    <div class="card">
      <h3>Live Ticker</h3>
      <div id="ticker" class="ticker muted" aria-live="polite"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Profile</h3>
      <div style="display:flex;gap:12px;align-items:center">
        <div style="width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-items:center;font-weight:800">U</div>
        <div>
          <div id="userName" style="font-weight:800">Guest</div>
          <div id="userMeta" class="muted">Lv 1 â€¢ XP 0</div>
          <div style="height:10px;background:rgba(255,255,255,0.04);border-radius:8px;margin-top:8px;overflow:hidden"><div id="xpFill" style="height:100%;width:0%;background:linear-gradient(90deg,var(--accent2),var(--accent1));"></div></div>
        </div>
      </div>
      <div style="margin-top:10px" class="controls">
        <button id="btnExport" class="btn ghost" aria-label="Export PDF">Export</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>3D Spotlight</h3>
      <div id="spotlight3d" class="three-wrap">
        <iframe id="spotFrame" class="sketch" src="" title="3D artist spotlight" allow="autoplay; fullscreen; vr; accelerometer"></iframe>
      </div>
      <div class="muted" style="margin-top:8px">Top artist visual</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Sponsored</h3>
      <div class="muted small">Ad placeholder â€” add ad code here for monetization</div>
    </div>
  </aside>
</main>

<footer>Â© 2025 AfroGenstas â€” Build, play & invest in Afrobeat culture</footer>

<!-- lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <img id="lightboxImg" alt="Artwork" />
</div>

<!-- animated install prompt -->
<div id="installPrompt" class="install-prompt" aria-hidden="true">
  <div style="display:flex;flex-direction:column">
    <div style="font-weight:900">Install AfroGenstas</div>
    <div style="font-size:.85rem" class="muted">Add to home screen for quick access</div>
  </div>
  <div style="margin-left:12px;display:flex;flex-direction:column;gap:6px">
    <button id="installAccept" class="btn">Install</button>
    <button id="installDismiss" class="btn ghost">Later</button>
  </div>
</div>

<!-- bottom nav (3D-style icons) -->
<div class="bottom-nav" role="navigation" aria-label="Bottom navigation">
  <div class="nav-item active" data-route="home" title="Home">
    <!-- home cube-ish SVG icon -->
    <svg class="svg-3d icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#7C5CFF"/><stop offset="1" stop-color="#FF7F50"/></linearGradient></defs>
      <rect x="3" y="7" width="18" height="10" rx="2" fill="url(#g1)" opacity="0.95" transform="rotate(-12 12 12)"></rect>
      <path d="M12 3 L4 9 L20 9 Z" fill="#021" opacity="0.12"></path>
    </svg>
  </div>

  <div class="nav-item" data-route="market" title="Market">
    <svg class="svg-3d icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs><linearGradient id="g2" x1="0" x2="1"><stop offset="0" stop-color="#FF7F50"/><stop offset="1" stop-color="#7C5CFF"/></linearGradient></defs>
      <rect x="4" y="6" width="16" height="12" rx="3" fill="url(#g2)"></rect>
      <path d="M7 16v-6m4 6v-10m4 10v-4" stroke="#021" stroke-width="1.6" stroke-linecap="round"></path>
    </svg>
  </div>

  <div class="nav-item" data-route="portfolio" title="Portfolio">
    <svg class="svg-3d icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" fill="#fff" opacity="0.03"/><path d="M7 9h10M7 13h10M7 17h6" stroke="#fff" stroke-opacity="0.9" stroke-width="1.4" stroke-linecap="round"/></svg>
  </div>

  <div class="nav-item" data-route="leaderboard" title="Leaderboard">
    <svg class="svg-3d icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" fill="#fff" opacity="0.03"/><path d="M9 15v-6M15 15v-10M12 15v-4" stroke="#fff" stroke-opacity="0.95" stroke-width="1.6" stroke-linecap="round"/></svg>
  </div>

  <div class="nav-item" data-route="gallery" title="Gallery">
    <svg class="svg-3d icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" fill="#fff" opacity="0.03"/><circle cx="9.5" cy="10.5" r="2.2" fill="#fff" opacity="0.9"/><path d="M21 19l-5-6-3 4-2-3-6 6" stroke="#fff" stroke-opacity="0.9" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </div>
</div>

<script>
/*
  AfroGenstas â€” single-file enhanced version
  - All logic contained here
  - Replace APP_CONFIG.SERVER_SUMMARIZE_URL with your serverless endpoint if you have it
  - No secret keys included in client
*/

(() => {
  'use strict';

  /* ---------------- CONFIG ---------------- */
  const APP_CONFIG = {
    SERVER_SUMMARIZE_URL: '', // e.g. https://your-vercel.app/api/summarize (optional)
    CLIENT_KEY: 'public-demo-key-123',
    VERSION: '1.0.0'
  };

  /* ---------------- Artists dataset (demo assets) ----------------
     Replace these poster/cover URLs with your hosted images (public/assets/...)
  */
  const ARTISTS = [
    { ticker:'$BURNA', name:'Burna Boy', color:'#FF7F50', poster:'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?q=80&w=1200&auto=format&fit=crop', cover:'https://images.unsplash.com/photo-1544148106-0c3b8403d5f4?q=80&w=1200&auto=format&fit=crop', sketch:'https://sketchfab.com/models/8208f257d2d3457183e866eb990e6511/embed' },
    { ticker:'$REMA', name:'Rema', color:'#39D98A', poster:'https://images.unsplash.com/photo-1520975687175-9e0c8d2b5d04?q=80&w=1200&auto=format&fit=crop', cover:'https://images.unsplash.com/photo-1505685296765-3a2736de412f?q=80&w=1200&auto=format&fit=crop', sketch:'https://sketchfab.com/models/4f2a3b8f3f2b4e0e9728f2bd1/embed' },
    { ticker:'$ASAKE', name:'Asake', color:'#7C5CFF', poster:'https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop', cover:'https://images.unsplash.com/photo-1544717305-2782549b5136?q=80&w=1200&auto=format&fit=crop', sketch:'https://sketchfab.com/models/9f6b0e3f3f374b4b8b4f6a4f/embed' }
  ];

  /* ---------------- State & Persistence ---------------- */
  const LS_KEY = 'afrogenstas_prod_v2';
  function defaultProfile(){ return { user:'Guest', xp:0, level:1, streak:0, quests:[], achievements:{}, portfolio:{ cash:15000, holdings:{}, history:[] } }; }
  let PROFILE = loadProfile();
  let currentRoute = 'home';
  const priceState = {}; // ticker -> { history:[], last, popularity }

  /* ---------------- Small helpers ---------------- */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function saveProfile(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(PROFILE)); }catch(e){ console.warn('save fail',e); } }
  function loadProfile(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || defaultProfile(); }catch(e){ return defaultProfile(); } }
  function nowISO(){ return new Date().toISOString(); }
  function toast(msg, timeout=2200){
    const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t);
    requestAnimationFrame(()=> { t.style.transform = 'translateY(0)'; t.style.opacity = '1'; });
    setTimeout(()=> { t.style.transform = 'translateY(30px)'; t.style.opacity = '0'; setTimeout(()=>t.remove(), 320); }, timeout);
  }
  function hexToRgba(hex,a=0.12){ const c=hex.replace('#',''); const r=parseInt(c.substring(0,2),16), g=parseInt(c.substring(2,4),16), b=parseInt(c.substring(4,6),16); return `rgba(${r},${g},${b},${a})`; }
  function fmt(v){ return '$' + Number(v).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }

  /* ---------------- Price simulation (realistic-ish) ---------------- */
  function initPrices(){
    ARTISTS.forEach(a=>{
      const base = 40 + Math.random()*220;
      priceState[a.ticker] = { history: Array.from({length:72}, (_,i)=> Math.round((base + Math.sin(i/6)*8 + Math.random()*8)*100)/100), last: Math.round(base*100)/100, popularity: 30 + Math.random()*70 };
    });
    tickPrices();
  }

  let tickTimer = null;
  function tickPrices(){
    // dynamic tick interval depending on "market volatility"
    ARTISTS.forEach(a=>{
      const s = priceState[a.ticker];
      // random walk influenced by popularity spikes
      const popImpulse = (Math.random() < 0.04) ? (3 + Math.random()*8) * (Math.random() < 0.5 ? -1 : 1) : 0;
      s.popularity = Math.max(0, Math.min(100, s.popularity + (Math.random()-0.5)*2 + (popImpulse>0?2:-0.6)));
      const noise = (Math.random()-0.5) * 0.02 + (s.popularity - 50) / 5000;
      s.last = Math.max(0.5, Math.round((s.last * (1 + noise) + popImpulse)*100)/100);
      s.history.push(s.last);
      if(s.history.length > 400) s.history.shift();
    });
    renderTicker();
    if(currentRoute === 'market') renderMarketBody();
    if(currentRoute === 'portfolio') updateHoldingsUI();
    updateSpotlight();
    // adaptive schedule for realism
    const delay = 2200 + Math.random()*2000;
    tickTimer = setTimeout(tickPrices, delay);
  }

  /* ---------------- 3D dynamic background (Three.js) ----------------
     - Animated torus knot + particle field
     - Reacts to simulated "beat" (we generate a beat pulse)
  */
  let threeContext = null;
  function init3DBackground(){
    try{
      const canvas = document.getElementById('bgCanvas');
      const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 1000);
      camera.position.set(0,0,70);

      // Torus knot focus
      const knotGeo = new THREE.TorusKnotGeometry(12, 1.4, 220, 24);
      const knotMat = new THREE.MeshStandardMaterial({ color: 0x7c5cff, roughness:0.6, metalness:0.15, emissive:0x2b1b6b, emissiveIntensity:0.12 });
      const knot = new THREE.Mesh(knotGeo, knotMat);
      knot.rotation.x = 0.5; scene.add(knot);

      // subtle particle field
      const pCount = 700;
      const positions = new Float32Array(pCount*3);
      for(let i=0;i<pCount;i++){
        positions[i*3+0] = (Math.random()-0.5) * 400;
        positions[i*3+1] = (Math.random()-0.5) * 150;
        positions[i*3+2] = (Math.random()-0.5) * 400;
      }
      const particleGeo = new THREE.BufferGeometry();
      particleGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      const particleMat = new THREE.PointsMaterial({ color: 0x00e5ff, size: 0.6, transparent:true, opacity:0.1 });
      const particles = new THREE.Points(particleGeo, particleMat);
      scene.add(particles);

      // lights
      const amb = new THREE.AmbientLight(0xffffff, 0.12); scene.add(amb);
      const dir = new THREE.DirectionalLight(0xffffff, 0.18); dir.position.set(50,50,100); scene.add(dir);

      // resize
      function onResize(){
        renderer.setSize(innerWidth, innerHeight);
        camera.aspect = innerWidth / innerHeight;
        camera.updateProjectionMatrix();
      }
      onResize(); window.addEventListener('resize', throttle(onResize, 220));

      // beat simulator (pulses)
      let lastPulse = 0;
      function simulateBeat(){
        // pulse every 0.6 - 1.1s with slight randomness
        const now = performance.now();
        if(now - lastPulse > 600 + Math.random()*500){
          lastPulse = now;
          return 1 + Math.random()*0.6;
        }
        return 1;
      }

      let t = 0;
      (function animate(){
        t += 0.004;
        const beat = simulateBeat();
        // motion
        knot.rotation.y += 0.002 + 0.001*beat;
        knot.rotation.x += 0.0008;
        knot.scale.setScalar(1 + 0.02*(beat-1));
        particles.rotation.y = -t*0.02;
        // color pulse based on market mood (simple metric)
        const mood = marketMoodNormalized();
        knot.material.emissiveIntensity = 0.08 + mood*0.35;
        renderer.render(scene, camera);
        requestAnimationFrame(animate);
      })();

      threeContext = { renderer, scene, camera, knot, particles };
      return true;
    }catch(e){
      console.warn('3D init failed', e);
      return false;
    }
  }

  // simple aggregated market mood (0...1 from negative to positive)
  function marketMoodNormalized(){
    let score = 0; ARTISTS.forEach(a => { const s = priceState[a.ticker]; const last = s.last; const hist = s.history; const prev = hist[hist.length-2] || hist[0]; score += Math.sign(last - prev) * Math.min(1, Math.abs((last-prev)/Math.max(1,prev))); });
    const normalized = (score / ARTISTS.length + 1)/2; return Math.max(0, Math.min(1, normalized));
  }

  // throttle helper
  function throttle(fn, wait=100){
    let t = null; return (...args) => { if(t) return; t = setTimeout(()=>{ fn(...args); t=null; }, wait); };
  }

  /* ---------------- Nav & routing ---------------- */
  const ROUTES = { home: renderHome, market: renderMarket, portfolio: renderPortfolio, leaderboard: renderLeaderboard, gallery: renderGallery, insights: renderInsights };
  function initNav(){
    // top nav buttons
    $$('#topNav button').forEach(b => {
      b.addEventListener('click', () => {
        $$('#topNav button').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        const route = b.dataset.route; navigate(route);
      });
    });
    // bottom nav
    $$('.bottom-nav .nav-item').forEach(n => {
      n.addEventListener('click', () => {
        $$('.bottom-nav .nav-item').forEach(x => x.classList.remove('active'));
        n.classList.add('active');
        const r = n.dataset.route; navigate(r);
        // micro interaction
        n.animate([{ transform:'translateY(0)' }, { transform:'translateY(-6px)' }, { transform:'translateY(0)' }], { duration:360, easing:'cubic-bezier(.2,.9,.2,1)' });
      });
    });
    // popstate
    window.addEventListener('popstate', () => {
      const r = location.hash.replace('#','') || 'home';
      navigate(r, true);
    });
  }
  function navigate(route, push=true){
    currentRoute = route || 'home';
    // top nav highlight
    $$('#topNav button').forEach(b => b.classList.toggle('active', b.dataset.route === route));
    // bottom nav highlight
    $$('.bottom-nav .nav-item').forEach(n => n.classList.toggle('active', n.dataset.route === route));
    if(push) history.pushState({route}, '', '#'+route);
    // render route
    const fn = ROUTES[route] || ROUTES['home'];
    fn();
  }

  /* ---------------- Renderers ---------------- */

  // HOME
  function renderHome(){
    const app = $('#app');
    app.innerHTML = `
      <div class="hero">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h2 style="margin:0">AfroGenstas</h2>
            <div class="muted">Music-meets-finance â€” invest in Afrobeat artists, trade song-futures, earn XP & compete.</div>
          </div>
          <div>
            <button id="openMarket" class="btn">Open Market</button>
            <button id="openPortfolio" class="btn ghost">My Portfolio</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Top Artists</h3>
        <div id="topArtists" class="grid-cards" style="margin-top:10px"></div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Spotlight 3D</h3>
        <div class="three-wrap"><iframe id="homeSpot" class="sketch" src="" title="spot"></iframe></div>
      </div>
    `;
    $('#openMarket').addEventListener('click', ()=> navigate('market'));
    $('#openPortfolio').addEventListener('click', ()=> navigate('portfolio'));
    // top artists cards
    const grid = $('#topArtists'); grid.innerHTML = '';
    ARTISTS.forEach(a => {
      const s = priceState[a.ticker];
      const card = document.createElement('div'); card.className = 'card';
      card.innerHTML = `<div style="display:flex;gap:12px;align-items:center">
        <div style="width:84px;height:84px;border-radius:12px;overflow:hidden"><img src="${a.poster}" style="width:100%;height:100%;object-fit:cover" alt="${a.name} poster"></div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div><strong>${a.name}</strong><div class="muted small">${a.ticker}</div></div>
            <div style="text-align:right"><div style="font-weight:900">${s.last.toFixed(2)}</div><div class="muted small">Pop ${s.popularity.toFixed(0)}</div></div>
          </div>
          <div style="margin-top:8px" class="controls"><button class="btn" data-buy="${a.ticker}">Buy</button><button class="btn ghost" data-view="${a.ticker}">View</button></div>
        </div>
      </div>`;
      grid.appendChild(card);
      card.querySelector('[data-buy]')?.addEventListener('click', ()=> openTradeModal('BUY', a.ticker));
      card.querySelector('[data-view]')?.addEventListener('click', ()=> openArtistPanel(a.ticker));
    });
    // homeSpot -> first artist sketch (if available)
    $('#homeSpot').src = ARTISTS[0].sketch || '';
  }

  // MARKET
  let marketChart = null;
  function renderMarket(){
    const app = $('#app');
    app.innerHTML = `
      <h2>Market</h2>
      <div class="muted">Interactive artist market â€” prices update in real-time simulation</div>

      <div style="margin-top:12px" class="card">
        <h3>Artists</h3>
        <table class="table"><thead><tr><th>Artist</th><th>Ticker</th><th>Price</th><th>Popularity</th><th>Action</th></tr></thead><tbody id="marketBody"></tbody></table>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Price History</h3>
        <canvas id="marketChart" style="height:200px"></canvas>
        <div style="margin-top:8px" class="controls">
          <select id="artistSelect" class="input">${ARTISTS.map(a=>`<option value="${a.ticker}">${a.ticker} â€” ${a.name}</option>`).join('')}</select>
          <button id="viewSeries" class="btn ghost">View Chart</button>
        </div>
      </div>
    `;
    renderMarketBody();
    $('#viewSeries').addEventListener('click', ()=> drawMarketChart($('#artistSelect').value));
    drawMarketChart(ARTISTS[0].ticker);
  }

  function renderMarketBody(){
    const tbody = $('#marketBody'); if(!tbody) return; tbody.innerHTML = '';
    ARTISTS.forEach(a => {
      const s = priceState[a.ticker];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.name}</td><td>${a.ticker}</td><td style="font-weight:900">${s.last.toFixed(2)}</td><td>${s.popularity.toFixed(0)}</td><td><div class="controls"><button class="btn" data-buy="${a.ticker}">Buy</button><button class="btn ghost" data-view="${a.ticker}">View</button></div></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('[data-buy]').forEach(b => b.addEventListener('click', e => openTradeModal('BUY', e.currentTarget.dataset.buy)));
    tbody.querySelectorAll('[data-view]').forEach(b => b.addEventListener('click', e => openArtistPanel(e.currentTarget.dataset.view)));
  }

  function drawMarketChart(ticker){
    const ctx = document.getElementById('marketChart').getContext('2d');
    const s = priceState[ticker];
    const series = s.history.slice(-160);
    if(marketChart) marketChart.destroy();
    marketChart = new Chart(ctx, {
      type:'line',
      data:{ labels: series.map((_,i)=>i), datasets:[{ data: series, borderColor: ARTISTS.find(a=>a.ticker===ticker).color, backgroundColor: hexToRgba(ARTISTS.find(a=>a.ticker===ticker).color, .12), fill:true, tension:0.28 }]},
      options:{plugins:{legend:{display:false}}, scales:{x:{display:false}}}
    });
  }

  // ARTIST PANEL
  function openArtistPanel(ticker){
    const artist = ARTISTS.find(a => a.ticker === ticker);
    if(!artist) return toast('Artist not found');
    // go to market view visually
    $$('#topNav button').forEach(b=> b.classList.toggle('active', b.dataset.route === 'market'));
    $$('.bottom-nav .nav-item').forEach(n=> n.classList.toggle('active', n.dataset.route === 'market'));

    const s = priceState[ticker];
    const app = $('#app');
    app.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h2>${artist.name} <small class="muted">${artist.ticker}</small></h2><div class="muted small">Last: ${s.last.toFixed(2)} â€¢ Pop ${s.popularity.toFixed(0)}</div></div>
        <div><button id="backToMarket" class="btn ghost">Back</button></div>
      </div>
      <div style="margin-top:12px" class="card">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1"><canvas id="artistChart" style="height:180px"></canvas></div>
          <div style="width:260px">
            <div style="height:160px;border-radius:12px;overflow:hidden"><img src="${artist.cover}" style="width:100%;height:100%;object-fit:cover" alt="${artist.name} cover" /></div>
            <div style="margin-top:8px" class="controls"><button id="tradeArtist" class="btn">Trade</button><button id="summBtn" class="btn ghost">Summarize</button></div>
            <div id="artistInfo" class="muted" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    `;
    $('#backToMarket').addEventListener('click', ()=> renderMarket());
    $('#tradeArtist').addEventListener('click', ()=> openTradeModal('BUY', ticker));
    $('#summBtn').addEventListener('click', async ()=> {
      const info = $('#artistInfo'); info.textContent = 'Generating summaryâ€¦';
      try{ const s = await summarize(`${artist.name} update: price ${priceState[ticker].last}, pop ${priceState[ticker].popularity}`); info.innerHTML = s.replace(/\n/g,'<br/>'); }catch(err){ info.textContent = 'AI error: ' + err.message; }
    });

    // draw chart
    const ctx = document.getElementById('artistChart').getContext('2d');
    const series = priceState[ticker].history.slice(-200);
    new Chart(ctx, { type:'line', data:{ labels: series.map((_,i)=>i), datasets:[{ data: series, borderColor: artist.color, backgroundColor: hexToRgba(artist.color,.12), fill:true, tension:0.28 }]}, options:{plugins:{legend:{display:false}}, scales:{x:{display:false}}} });
  }

  // TRADE modal (in-page)
  function openTradeModal(side='BUY', ticker=null){
    const app = $('#app');
    const modal = document.createElement('div'); modal.className = 'card'; modal.style.marginBottom = '12px';
    modal.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><h3>${side} ${ticker || ''}</h3><div class="muted small">Quick trade</div></div>
        <div><button class="btn ghost close">Close</button></div>
      </div>
      <div style="margin-top:12px" class="controls">
        <select id="trTicker" class="input">${ARTISTS.map(a=>`<option value="${a.ticker}">${a.ticker} â€” ${a.name}</option>`).join('')}</select>
        <input id="trQty" type="number" min="1" value="1" class="input" style="width:110px" />
        <button id="trConfirm" class="btn">${side}</button>
      </div>
      <div id="trPreview" class="muted small" style="margin-top:8px"></div>
    `;
    app.prepend(modal);
    if(ticker) modal.querySelector('#trTicker').value = ticker;
    modal.querySelector('.close').addEventListener('click', ()=> modal.remove());
    const preview = modal.querySelector('#trPreview');
    const updatePreview = ()=> {
      const t = modal.querySelector('#trTicker').value; const q = Math.max(1, Math.floor(Number(modal.querySelector('#trQty').value) || 1));
      const price = priceState[t].last; preview.innerHTML = `Price: <strong>${price.toFixed(2)}</strong> â€¢ Total: <strong>${(price*q).toFixed(2)}</strong>`;
    };
    modal.querySelector('#trTicker').addEventListener('change', updatePreview);
    modal.querySelector('#trQty').addEventListener('input', updatePreview);
    updatePreview();
    modal.querySelector('#trConfirm').addEventListener('click', ()=> {
      const t = modal.querySelector('#trTicker').value; const q = Math.max(1, Math.floor(Number(modal.querySelector('#trQty').value) || 1));
      executeTrade(side, t, q); modal.remove();
    });
  }

  // EXECUTE TRADE
  function executeTrade(side, ticker, qty){
    const price = priceState[ticker].last;
    if(side === 'BUY'){
      const cost = price * qty;
      if(cost > PROFILE.portfolio.cash){ toast('Insufficient cash'); return; }
      const hold = PROFILE.portfolio.holdings[ticker] || { qty:0, avg:0 };
      const newQty = hold.qty + qty;
      const newAvg = ((hold.avg * hold.qty) + price*qty) / (newQty || 1);
      PROFILE.portfolio.holdings[ticker] = { qty: newQty, avg: newAvg };
      PROFILE.portfolio.cash -= cost;
      PROFILE.portfolio.history.push({ t: nowISO(), action:'BUY', ticker, qty, price });
      PROFILE.xp = (PROFILE.xp || 0) + Math.max(6, Math.round(qty * 0.6));
      toast(`Bought ${qty} ${ticker}`);
    } else {
      const hold = PROFILE.portfolio.holdings[ticker];
      if(!hold || hold.qty <= 0){ toast('No holdings to sell'); return; }
      const sellQty = Math.min(qty, hold.qty);
      hold.qty -= sellQty; if(hold.qty === 0) delete PROFILE.portfolio.holdings[ticker];
      PROFILE.portfolio.cash += sellQty * price;
      PROFILE.portfolio.history.push({ t: nowISO(), action:'SELL', ticker, qty: sellQty, price });
      PROFILE.xp = (PROFILE.xp || 0) + Math.max(4, Math.round(qty * 0.3));
      toast(`Sold ${sellQty} ${ticker}`);
    }
    // level up logic
    levelCheck();
    saveProfile(); updateHoldingsUI(); drawPortfolioChart(); updateProfileUI();
  }

  // LEVEL & XP
  function levelCheck(){
    const lvlXp = 100 + (PROFILE.level - 1) * 75;
    while((PROFILE.xp || 0) >= lvlXp){
      PROFILE.xp -= lvlXp; PROFILE.level += 1; PROFILE.achievements['level_'+PROFILE.level] = { at: nowISO() }; toast(`Level up! You are now level ${PROFILE.level} ðŸŽ‰`);
    }
  }

  // PORTFOLIO VIEW
  let portfolioChart = null;
  function renderPortfolio(){
    const app = $('#app');
    app.innerHTML = `
      <h2>Your Portfolio</h2>
      <div class="muted">Cash, holdings & analytics</div>

      <div style="margin-top:12px" class="card">
        <h3>Holdings</h3>
        <table class="table"><thead><tr><th>Artist</th><th>Ticker</th><th>Qty</th><th>Avg</th><th>Last</th><th>Value</th><th>P/L</th><th>Action</th></tr></thead><tbody id="holdingsTbl"></tbody></table>
        <div style="margin-top:10px" class="muted">Cash: <strong id="cashVal"></strong> â€¢ Total: <strong id="totalVal"></strong></div>
      </div>

      <div style="margin-top:12px" class="card">
        <h3>Performance</h3>
        <canvas id="portfolioChart" style="height:200px"></canvas>
        <div id="portfolioMetrics" class="muted" style="margin-top:8px"></div>
      </div>
    `;
    updateHoldingsUI();
    drawPortfolioChart();
  }

  function updateHoldingsUI(){
    const tbody = $('#holdingsTbl'); if(!tbody) return; tbody.innerHTML = '';
    let equity = 0;
    for(const [t,h] of Object.entries(PROFILE.portfolio.holdings)){
      const art = ARTISTS.find(a => a.ticker === t) || { name: t };
      const last = priceState[t].last; const value = last * h.qty; equity += value;
      const pl = (last - h.avg) * h.qty;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${art.name}</td><td>${t}</td><td>${h.qty}</td><td>${h.avg.toFixed(2)}</td><td>${last.toFixed(2)}</td><td>${value.toFixed(2)}</td><td style="color:${pl>=0? '#2dd4bf':'#ff6b6b'}">${pl>=0?'+':''}${pl.toFixed(2)}</td><td><button class="btn ghost" data-sell="${t}">Sell</button></td>`;
      tbody.appendChild(tr);
    }
    tbody.querySelectorAll('[data-sell]').forEach(b => b.addEventListener('click', e => openTradeModal('SELL', e.currentTarget.dataset.sell)));
    const total = equity + PROFILE.portfolio.cash;
    $('#cashVal').textContent = fmt(PROFILE.portfolio.cash);
    $('#totalVal').textContent = fmt(total);
    updateSnapshot(); saveProfile();
  }

  // portfolio timeseries
  function getPortfolioSeries(){
    const len = 64; const series = [];
    for(let i=0;i<len;i++){
      let tot = 0;
      for(const [t,h] of Object.entries(PROFILE.portfolio.holdings)){
        const hist = priceState[t].history; const idx = Math.max(0, hist.length - len + i);
        tot += (hist[idx] || hist[0] || 100) * h.qty;
      }
      series.push(tot + PROFILE.portfolio.cash);
    }
    return series;
  }

  function drawPortfolioChart(){
    const canvas = document.getElementById('portfolioChart'); if(!canvas) return;
    const series = getPortfolioSeries();
    if(portfolioChart) portfolioChart.destroy();
    portfolioChart = new Chart(canvas.getContext('2d'), { type:'line', data:{ labels: series.map((_,i)=>i), datasets:[{ data: series, borderColor:'#6c5cff', backgroundColor: hexToRgba('#6c5cff', .12), fill:true }]}, options:{plugins:{legend:{display:false}}, scales:{x:{display:false}}} });
    const metrics = computeMetrics(series);
    $('#portfolioMetrics').textContent = `Ann Return: ${(metrics.annual_return*100).toFixed(2)}% â€¢ Vol: ${(metrics.volatility_ann*100).toFixed(2)}% â€¢ Sharpe: ${metrics.sharpe.toFixed(2)}`;
  }

  /* ---------------- Leaderboard ---------------- */
  let LEADERBOARD = [ { user:'Keita', value:32200 }, { user:'Aisha', value:27140 }, { user:'Tunde', value:19870 }, { user:'You', value:0 } ];
  function renderLeaderboard(){
    const app = $('#app'); app.innerHTML = `<h2>Leaderboard</h2><div class="muted">Top community portfolios</div><div style="margin-top:12px" id="lbWrap"></div>`;
    const wrap = $('#lbWrap'); wrap.innerHTML = '';
    LEADERBOARD.sort((a,b)=>b.value-a.value);
    LEADERBOARD.forEach((p,i)=> {
      const c = document.createElement('div'); c.className = 'card';
      c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${i+1}. ${p.user}</strong><div class="muted small">Portfolio value</div></div><div style="font-weight:900">${fmt(p.value)}</div></div>`;
      wrap.appendChild(c);
    });
  }

  /* ---------------- Gallery ---------------- */
  function renderGallery(){
    const app = $('#app'); app.innerHTML = `<h2>Gallery</h2><div class="muted">Cover art & posters</div><div style="margin-top:12px" class="card"><div class="grid-cards" id="galleryGrid"></div></div>`;
    const g = $('#galleryGrid'); g.innerHTML = '';
    ARTISTS.forEach(a => {
      const d = document.createElement('div'); d.className = 'poster'; d.innerHTML = `<img src="${a.poster}" alt="${a.name} poster"/>`; g.appendChild(d);
      d.addEventListener('click', ()=> openLightbox(a.poster));
    });
  }

  /* ---------------- AI Insights (serverless hook optional) ---------------- */
  function renderInsights(){
    const app = $('#app'); app.innerHTML = `
      <h2>AI Insights</h2><div class="muted">Paste a snippet and generate a concise summary & trading angle (serverless Gemini recommended)</div>
      <div style="margin-top:12px" class="card">
        <textarea id="aiText" rows="6" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff"></textarea>
        <div class="controls" style="margin-top:8px">
          <button id="btnAI" class="btn">Generate</button>
          <button id="btnLocal" class="btn ghost">Local (offline)</button>
        </div>
        <div id="aiOut" class="muted" style="margin-top:8px"></div>
      </div>`;
    $('#btnAI').addEventListener('click', async ()=>{
      const text = $('#aiText').value.trim(); if(!text) return toast('Paste text first');
      $('#aiOut').textContent = 'Generatingâ€¦';
      try{ const out = await summarize(text); $('#aiOut').innerHTML = out.replace(/\n/g,'<br/>'); }catch(e){ $('#aiOut').textContent = 'AI error: ' + e.message; }
    });
    $('#btnLocal').addEventListener('click', ()=> { $('#aiOut').textContent = localSummarize($('#aiText').value.trim()); });
  }

  /* ---------------- Summarize API (optional) ---------------- */
  async function summarize(text){
    if(!APP_CONFIG.SERVER_SUMMARIZE_URL) return localSummarize(text);
    const res = await fetch(APP_CONFIG.SERVER_SUMMARIZE_URL, { method:'POST', headers:{ 'Content-Type':'application/json', 'x-client-key': APP_CONFIG.CLIENT_KEY }, body: JSON.stringify({ text }) });
    if(!res.ok){ const t = await res.text(); throw new Error(t || res.status); }
    const j = await res.json(); return j.summary || j.result || j.output || '';
  }
  function localSummarize(text){
    if(!text) return '';
    const s = text.split(/[.?!]\s+/).filter(Boolean); if(s.length<=2) return text;
    const first = s[0]; const sorted = [...s].sort((a,b)=>b.length-a.length); return `${first}.\n\nâ€¢ ${sorted[0]}.\n\nâ€¢ ${sorted[1]}.`;
  }

  /* ---------------- PDF export (jsPDF) ---------------- */
  async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit:'pt', format:'a4' });
    doc.setFontSize(16); doc.text("AfroGenstas â€” Portfolio Report", 40, 60);
    doc.setFontSize(11); doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);
    doc.text(`User: ${PROFILE.user}`, 40, 98); doc.text(`Cash: ${fmt(PROFILE.portfolio.cash)}`, 40, 116);
    let y=140; doc.text("Holdings:", 40, y); y+=14;
    for(const [t,h] of Object.entries(PROFILE.portfolio.holdings)){
      const last = priceState[t].last; doc.text(`${t} â€¢ Qty: ${h.qty} â€¢ Avg: ${h.avg.toFixed(2)} â€¢ Last: ${last.toFixed(2)} â€¢ Value: ${(last*h.qty).toFixed(2)}`, 48, y);
      y += 12; if(y>720){ doc.addPage(); y=40; }
    }
    doc.save(`afrogenstas-report-${Date.now()}.pdf`);
  }

  /* ---------------- Utilities: compute metrics ---------------- */
  function computeMetrics(series){
    if(!series || series.length < 2) return { annual_return:0, volatility_ann:0, sharpe:0 };
    const rets = []; for(let i=1;i<series.length;i++) rets.push((series[i]-series[i-1])/series[i-1]);
    const mean = rets.reduce((a,b)=>a+b,0)/rets.length; const variance = rets.reduce((a,b)=>a+(b-mean)*(b-mean),0)/(Math.max(1,rets.length-1));
    const sd = Math.sqrt(variance); const volAnn = sd * Math.sqrt(252); const ann = mean * 252; const sharpe = volAnn>0 ? ann/volAnn : 0;
    return { annual_return: ann, volatility_ann: volAnn, sharpe };
  }

  /* ---------------- Lightbox ---------------- */
  function openLightbox(src){ $('#lightboxImg').src = src; $('#lightbox').style.display = 'grid'; $('#lightbox').setAttribute('aria-hidden','false'); }
  $('#lightbox')?.addEventListener('click', ()=> { $('#lightbox').style.display='none'; $('#lightbox').setAttribute('aria-hidden','true'); });

  /* ---------------- Snapshot & leaderboard update ---------------- */
  function updateSnapshot(){
    let equity = 0; for(const [t,h] of Object.entries(PROFILE.portfolio.holdings)) equity += (priceState[t].last || 0) * h.qty;
    const total = PROFILE.portfolio.cash + equity; // store user's current value into leaderboard
    // update sidebar snapshot if exists
    // also update leaderboard 'You'
    const you = LEADERBOARD.find(l => l.user === 'You') || (LEADERBOARD[3] = { user:'You', value:0 });
    you.value = Math.round(total);
  }

  /* ---------------- Gamified quests (simple) ---------------- */
  const QUESTS = [
    { id:'first_trade', title:'Make your first trade', xp:40, desc:'Make any buy or sell' },
    { id:'diversify', title:'Hold 3 artists', xp:60, desc:'Hold at least 3 different artists' },
    { id:'daily_open', title:'Daily check-in', xp:10, desc:'Open the app 7 days in a row' }
  ];
  function tryCompleteQuest(id){
    if(PROFILE.quests.includes(id)) return;
    if(id === 'first_trade'){
      if(PROFILE.portfolio.history.length > 0){ PROFILE.quests.push(id); PROFILE.xp += 40; toast('Quest complete: First trade +40 XP'); levelCheck(); saveProfile(); }
      else toast('Make a trade first to complete this quest');
    } else if(id === 'diversify'){
      if(Object.keys(PROFILE.portfolio.holdings).length >= 3){ PROFILE.quests.push(id); PROFILE.xp += 60; toast('Quest complete: Diversify +60 XP'); levelCheck(); saveProfile(); }
      else toast('Hold at least 3 different artists');
    }
  }

  /* ---------------- UI helpers ---------------- */
  function updateProfileUI(){
    $('#userName').textContent = PROFILE.user || 'Guest';
    $('#userMeta').textContent = `Lv ${PROFILE.level} â€¢ XP ${PROFILE.xp || 0}`;
    const lvlXp = 100 + (PROFILE.level - 1) * 75;
    const pct = Math.min(100, Math.round((PROFILE.xp || 0) / (lvlXp || 100) * 100));
    $('#xpFill').style.width = pct + '%';
  }

  /* ---------------- Export / Install prompt (animated) ---------------- */
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); deferredPrompt = e;
    showInstallPrompt();
  });

  function showInstallPrompt(){
    const p = $('#installPrompt'); p.classList.add('show'); p.setAttribute('aria-hidden','false');
    $('#installAccept').onclick = async () => {
      p.classList.remove('show'); p.setAttribute('aria-hidden','true');
      if(!deferredPrompt){ toast('Install unavailable'); return; }
      deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; if(choice.outcome === 'accepted') toast('App installed â€” welcome!'); else toast('Install dismissed');
      deferredPrompt = null;
    };
    $('#installDismiss').onclick = ()=> { p.classList.remove('show'); p.setAttribute('aria-hidden','true'); toast('You can install later from browser menu'); };
    // auto hide after 10s if not interacted
    setTimeout(()=> { p.classList.remove('show'); p.setAttribute('aria-hidden','true'); }, 12000);
  }

  /* ---------------- Runtime service worker & manifest generation ---------------- */
  async function registerRuntimeSW(){
    if(!('serviceWorker' in navigator)) return;
    const sw = `
      const CACHE = 'afrogenstas-static-v1';
      self.addEventListener('install', e=> { self.skipWaiting(); });
      self.addEventListener('activate', e=> { self.clients.claim(); });
      self.addEventListener('fetch', e=> {
        if(e.request.method !== 'GET') return;
        e.respondWith(fetch(e.request).catch(()=> caches.match(e.request).then(r => r || caches.match('/index.html'))));
      });
    `;
    try{
      const blob = new Blob([sw], { type:'text/javascript' });
      const url = URL.createObjectURL(blob);
      await navigator.serviceWorker.register(url);
      console.log('runtime SW registered');
    }catch(e){ console.warn('SW failed', e); }
  }
  function createManifest(){
    const manifest = { name:'AfroGenstas', short_name:'AfroGenstas', start_url:'.', display:'standalone', background_color:'#04050a', theme_color:'#7C5CFF',
      icons:[{src:'https://api.dicebear.com/6.x/shapes/svg?seed=afrogenstas', sizes:'192x192', type:'image/svg+xml'}] };
    const blob = new Blob([JSON.stringify(manifest)], { type:'application/json' });
    const url = URL.createObjectURL(blob); let link = document.querySelector('link[rel="manifest"]'); if(!link){ link = document.createElement('link'); link.rel='manifest'; document.head.appendChild(link); } link.href = url;
  }

  /* ---------------- init & boot ---------------- */
  function boot(){
    // init UI
    initNav();
    createManifest();
    registerRuntimeSW();
    init3DBackground();
    initPrices();
    updateProfileUI();
    // initial route
    const start = location.hash.replace('#','') || 'home';
    navigate(start, false);
    // wire global elements
    $('#btnExport')?.addEventListener('click', exportPDF);
    // small initial rendering
    setTimeout(()=> { renderTicker(); updateSnapshot(); updateSpotlightFrame(); }, 600);
  }

  /* ---------------- render ticker ---------------- */
  function renderTicker(){
    const el = $('#ticker'); if(!el) return; el.innerHTML = '';
    ARTISTS.forEach(a => {
      const s = priceState[a.ticker]; const prev = s.history[s.history.length-2] || s.last; const pct = prev ? ((s.last - prev)/prev)*100 : 0;
      const d = document.createElement('div'); d.className = 'tick';
      d.innerHTML = `<div><div style="font-weight:800">${a.ticker}</div><div class="muted small">${a.name}</div></div><div style="text-align:right"><div style="font-weight:900">${s.last.toFixed(2)}</div><div class="muted small" style="color:${pct>=0?'#2dd4bf':'#ff6b6b'}">${pct>=0?'+':''}${pct.toFixed(2)}%</div></div>`;
      el.appendChild(d);
    });
  }

  /* ---------------- Update spotlight 3D frame ---------------- */
  function updateSpotlightFrame(){
    const top = getTopArtist(); if(!top) return; $('#spotFrame').src = top.sketch || '';
  }
  function getTopArtist(){ let best=null, bestScore=-Infinity; ARTISTS.forEach(a=>{ const s = priceState[a.ticker]; const score = s.last * (1 + s.popularity/100); if(score>bestScore){ bestScore=score; best=a; } }); return best; }

  /* ---------------- Metrics helpers ---------------- */
  function computeMetrics(series){
    if(!series || series.length<2) return { annual_return:0, volatility_ann:0, sharpe:0 };
    const rets=[]; for(let i=1;i<series.length;i++) rets.push((series[i]-series[i-1])/series[i-1]);
    const mean = rets.reduce((a,b)=>a+b,0)/rets.length; const variance = rets.reduce((a,b)=>a+(b-mean)*(b-mean),0)/(Math.max(1,rets.length-1));
    const sd=Math.sqrt(variance); const volAnn = sd*Math.sqrt(252); const ann = mean*252; const sharpe = volAnn>0?ann/volAnn:0;
    return { annual_return: ann, volatility_ann: volAnn, sharpe };
  }

  /* ---------------- Helper: cleanup when leaving heavy pages (optional) ---------------- */
  // if we needed to destroy charts when navigating away we would do so (Chart.js handles destroy on new assignment)

  /* ---------------- Local summarizer fallback ---------------- */
  function localSummarize(text){ if(!text) return ''; const s = text.split(/[.?!]\s+/).filter(Boolean); if(s.length<=2) return text; const first=s[0]; const sorted=[...s].sort((a,b)=>b.length-a.length); return `${first}.\n\nâ€¢ ${sorted[0]}.\n\nâ€¢ ${sorted[1]}.`; }

  /* ---------------- Start app ---------------- */
  boot();

  /* ---------------- Expose some debug helpers on window (dev only) ---------------- */
  window.Afrogenstas = { PROFILE, ARTISTS, priceState, navigate, openTradeModal, openArtistPanel };

  /* ---------------- END IIFE ---------------- */
})();

</script>
</body>
</html>
