<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AfroGenstas — Demo (MVP + WalletConnect + Soft Wallet)</title>
<meta name="description" content="AfroGenstas demo: simulated Afrobeat artist market, soft wallet, WalletConnect, staking pools, leaderboards, charts, 3D demo, and PWA support.">
<link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><circle cx=%2232%22 cy=%2232%22 r=%2228%22 fill=%22%236E00FF%22/></svg>">
<!-- Inline critical styles (theme tokens) -->
<style>
:root{
  --bg:#0B1020; --surface:#0f1424; --muted:#A8B0C2; --text:#E6E9F2;
  --primary:#6E00FF; --accent:#FF2E9F; --gold:#FFC700; --teal:#00C2A8;
  --glass: rgba(255,255,255,0.04); --radius:12px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);background:
radial-gradient(900px 400px at 10% -10%, rgba(110,0,255,0.18), transparent 40%),
radial-gradient(700px 300px at 110% 40%, rgba(255,46,159,0.08), transparent 40%),var(--bg);}
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;position:sticky;top:0;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03)}
.brand{display:flex;align-items:center;gap:12px}
.brand .mark{width:44px;height:44px;border-radius:999px;background:linear-gradient(135deg,var(--gold),var(--accent));box-shadow:0 6px 20px rgba(0,0,0,0.4);display:inline-flex;align-items:center;justify-content:center;font-weight:700}
.brand h1{font-size:18px;margin:0;color:var(--text)}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:999px;border:0;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
.container{width:min(1100px,94vw);margin:20px auto}
.grid{display:grid;grid-template-columns:1fr 340px;gap:18px;align-items:start}
.panel{background:var(--glass);padding:16px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.04)}
.market-list{display:grid;gap:10px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
.ticker{font-weight:700;color:var(--gold)}
.small{color:var(--muted);font-size:13px}
.footer{padding:24px;text-align:center;color:var(--muted)}
.switch{display:inline-flex;border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,0.06)}
.switch button{background:transparent;border:0;padding:8px 10px;color:var(--text);cursor:pointer}
.switch button.active{background:var(--primary);color:#fff}
.h1{font-size:28px;margin:4px 0}
.lead{color:var(--muted);margin:6px 0 12px}
.smallmuted{color:var(--muted);font-size:12px}
.controls .pill{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:13px}
.legend{display:flex;gap:8px;flex-wrap:wrap}
.branding-explain{font-size:13px;color:var(--muted);margin-top:6px}
kbd{background:#0b0f1a;border-radius:6px;padding:2px 6px;border:1px solid rgba(255,255,255,0.03);font-family:monospace}
.leaderboard{display:flex;flex-direction:column;gap:8px}
.lb-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.badge{background:var(--teal);padding:4px 8px;border-radius:999px;color:#042; font-weight:700}
.center{display:flex;align-items:center;justify-content:center}
.small-note{font-size:12px;color:var(--muted)}
.canvas-wrap{height:220px}
@media (max-width:900px){ .grid{grid-template-columns:1fr} .container{padding-bottom:60px} }
</style>
</head>
<body>
  <header class="header" role="banner">
    <div class="brand" aria-hidden="false">
      <div class="mark" title="AfroGenstas">AG</div>
      <div>
        <h1>AfroGenstas</h1>
        <div class="smallmuted">Stake · Trade · Celebrate Afrobeat Stars</div>
      </div>
    </div>

    <div class="controls" role="navigation" aria-label="Top controls">
      <div class="pill smallmuted">Simulation only</div>
      <div class="switch" role="tablist" aria-label="Theme">
        <button id="btnNeon" class="active" aria-pressed="true">Neon</button>
        <button id="btnContrast">Contrast</button>
      </div>
      <button id="btnEdit" class="btn ghost">Edit Content</button>
      <button id="btnInstall" class="btn">Install PWA</button>
    </div>
  </header>

  <main class="container" role="main">
    <section class="grid" aria-live="polite">
      <!-- MAIN COLUMN -->
      <div>
        <!-- HERO -->
        <div class="panel" role="region" aria-label="Hero">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div class="h1">Play the Market. Feel the Rhythm.</div>
              <div class="lead">Draft Davido or Ayra Starr — build a portfolio, stake in Hype Pools, and generate AI insights. Simulation only.</div>
            </div>
            <div class="center" style="flex-direction:column;gap:8px">
              <button id="btnStart" class="btn">Start Trading</button>
              <div class="smallmuted">Avg session target: 8+ minutes</div>
            </div>
          </div>
        </div>

        <!-- MARKET -->
        <div class="panel" style="margin-top:12px" role="region" aria-label="Market">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>Artist Market</strong>
            <div class="legend smallmuted">
              <span class="smallmuted">Volatility legend</span>
              <span class="badge">High</span>
            </div>
          </div>

          <div id="marketList" class="market-list" aria-live="polite"></div>
        </div>

        <!-- CHART & PORTFOLIO -->
        <div class="panel" style="margin-top:12px" role="region" aria-label="Charts & Portfolio">
          <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
            <strong id="selectedLabel">Select an artist</strong>
            <div><span class="smallmuted">Portfolio Value:</span> <strong id="portfolioValue">₳ 0</strong></div>
          </div>
          <div style="display:flex;gap:12px;margin-top:8px;align-items:center">
            <div style="flex:1" class="canvas-wrap">
              <canvas id="priceChart"></canvas>
            </div>
            <div style="width:220px">
              <div class="smallmuted">Actions</div>
              <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
                <button id="buyBtn" class="btn">Buy 10</button>
                <button id="sellBtn" class="btn ghost">Sell 10</button>
                <button id="stakeBtn" class="btn">Stake in Pool</button>
                <button id="claimBtn" class="btn ghost">Claim Rewards</button>
              </div>
              <div style="margin-top:12px" class="small-note">Prices simulated via volatility engine (browser). Social sentiment = mocked.</div>
            </div>
          </div>
        </div>

        <!-- 3D STAGE (Simple demo) -->
        <div class="panel" style="margin-top:12px" role="region" aria-label="3D Stage">
          <strong>3D Stage (demo)</strong>
          <div id="threeWrap" style="height:240px;margin-top:8px;border-radius:10px;overflow:hidden;background:#05060a" aria-hidden="false"></div>
          <div class="smallmuted" style="margin-top:8px">Tap to toggle orbit animation. Low-poly demo — heavy models are lazy-loaded in prod.</div>
        </div>

      </div>

      <!-- RIGHT COLUMN -->
      <aside style="width:340px">
        <!-- WALLETS -->
        <div class="panel" role="region" aria-label="Wallet">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Wallet</strong>
            <div class="smallmuted">Soft wallet + WalletConnect</div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="softWalletBtn" class="btn">Create Soft Wallet</button>
            <button id="connectBtn" class="btn ghost">Connect Wallet</button>
          </div>
          <div id="walletInfo" style="margin-top:12px" class="smallmuted">No wallet yet</div>
        </div>

        <!-- EARN & REWARDS -->
        <div class="panel" style="margin-top:12px" role="region" aria-label="Rewards">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>AfroPoints</strong>
            <div class="smallmuted">Earn & redeem</div>
          </div>
          <div style="margin-top:8px">
            <div id="pointsBal" style="font-size:18px;font-weight:700">0 AFRO</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="earnBtn" class="btn">Earn +10</button>
              <button id="redeemBtn" class="btn ghost">Redeem</button>
            </div>
            <div class="smallmuted" style="margin-top:8px">Points stored locally. Later: redeem for perks or off-chain drops.</div>
          </div>
        </div>

        <!-- STAKING POOL -->
        <div class="panel" style="margin-top:12px" role="region" aria-label="Staking">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Hype Pools</strong>
            <div class="smallmuted">Dynamic APR</div>
          </div>
          <div id="pools" style="margin-top:8px"></div>
          <div class="smallmuted" style="margin-top:8px">Stake tokens to earn AfroPoints. APR adjusts to hype & volatility.</div>
        </div>

        <!-- LEADERBOARD -->
        <div class="panel" style="margin-top:12px" role="region" aria-label="Leaderboard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Weekly Leaderboard</strong>
            <div class="smallmuted">Top fans</div>
          </div>
          <div id="leaderboard" style="margin-top:8px" class="leaderboard"></div>
          <div style="display:flex;gap:8px;margin-top:8px"><button id="shareBtn" class="btn">Share</button><button id="joinLeague" class="btn ghost">Join League</button></div>
        </div>

      </aside>
    </section>

    <section style="margin-top:18px" class="panel" role="region" aria-label="AI Insights">
      <strong>Gemini AI Insights (Demo)</strong>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button id="aiGenBtn" class="btn">Generate Insight (Lite)</button>
        <button id="aiDeepBtn" class="btn ghost">Deep Research (Pro)</button>
        <div class="smallmuted">Batched & cached to save calls</div>
      </div>
      <div id="aiOutput" style="margin-top:12px" class="smallmuted">No insights yet.</div>
    </section>

  </main>

  <footer class="footer">
    <div class="smallmuted">AfroGenstas Demo • Simulation only. No real money trading. Built for demo & prototype purposes.</div>
  </footer>

<!-- Third-party libs are lazy-loaded to reduce initial payload -->
<script>
/* -----------------------------
   Utility & State bootstrap
   ----------------------------- */
const STATE = {
  artists: [],      // {ticker,name,price,vol,history[]}
  portfolio: {},    // ticker -> qty
  softWallet: null, // {privateKey,address,points}
  web3Provider: null,
  web3Signer: null,
  leaderboard: [],  // [{name,points}]
  pools: [],        // {id,artist,apr,staked}
  selected: null,
  aiCache: {}       // key -> {ts,content}
};

const ARTISTS = [
  ["$WIZK","Wizkid","med"],
  ["$TEM","Tems","low"],
  ["$BURNA","Burna Boy","high"],
  ["$AYRA","Ayra Starr","med"],
  ["$REMA","Rema","med"],
  ["$DAVI","Davido","high"],
  ["$ASAK","Asake","med"],
  ["$TIWA","Tiwa Savage","low"],
  ["$CKAY","CKay","med"],
  ["$JOE","Joeboy","low"],
  ["$KIZZ","Kizz Daniel","med"],
  ["$OMAH","Omah Lay","med"],
  ["$YEMI","Yemi Alade","low"],
  ["$MRPS","Mr Eazi","low"],
  ["$TAYO","Tayo","med"],
  ["$ZINO","Zinoleesky","high"],
  ["$LYTA","Lyta","low"],
  ["$BLAQ","Blaqbonez","med"],
  ["$NYA","Nyashinski","low"],
  ["$FIRE","Fireboy","med"]
];

/* Basic RNG helpers */
const rand = (a,b)=> a + Math.random()*(b-a);
const clamp = (v,a,b)=> Math.max(a,Math.min(b,v));
const now = ()=>Date.now();

/* Storage helpers */
function saveLS(){ localStorage.setItem('afro_state', JSON.stringify({portfolio:STATE.portfolio,softWallet:STATE.softWallet,leaderboard:STATE.leaderboard,pools:STATE.pools})); }
function loadLS(){
  try{
    const raw = localStorage.getItem('afro_state');
    if(raw){ const parsed=JSON.parse(raw); STATE.portfolio=parsed.portfolio||{}; STATE.softWallet=parsed.softWallet||null; STATE.leaderboard=parsed.leaderboard||[]; STATE.pools=parsed.pools||[]; }
  }catch(e){}
}

/* Init artists with simulated base prices and vol */
function initArtists(){
  STATE.artists = ARTISTS.map(([ticker,name,vol])=>{
    const volMap = {low:0.015, med:0.03, high:0.07};
    const price = Math.round(rand(50,1200)); // base price units (simulation)
    return {ticker,name,price,volatility:volMap[vol],history:[{t:now(),p:price}],sentiment:0};
  });
  // create 3 pools for demo
  STATE.pools = [
    {id:"pool-1",artist:STATE.artists[0].ticker,staked:0,apr:8},
    {id:"pool-2",artist:STATE.artists[2].ticker,staked:0,apr:12},
    {id:"pool-3",artist:STATE.artists[4].ticker,staked:0,apr:6}
  ];
  saveLS();
}

/* -----------------------------
   Price sim engine (GBM + shock)
   - runs on interval; updates history
   ----------------------------- */
function stepPriceSim(){
  const dt = 1/24; // time-step (days)
  STATE.artists.forEach(a=>{
    // Brownian increment
    const mu = 0; // drift
    const sigma = a.volatility;
    const S = a.price;
    // Normal approx by Box–Muller
    const u1 = Math.random(), u2=Math.random();
    const z = Math.sqrt(-2*Math.log(u1))*Math.cos(2*Math.PI*u2);
    const dS = S * (mu*dt + sigma*Math.sqrt(dt)*z);
    // sentiment shock occasionally
    let shock = 0;
    if(Math.random() < 0.03){ // 3% chance per tick
      const mag = rand(-0.2,0.4); // -20% to +40%
      shock = S * mag;
    }
    let newP = Math.max(1, Math.round(S + dS + shock));
    // mean reversion: pull towards 300-ish
    newP = Math.round(newP - 0.002*(newP-300));
    a.price = newP;
    a.history.push({t:now(),p:newP});
    // trim history
    if(a.history.length > 300) a.history.shift();
  });
  renderMarket();
  updateChart(); // update selected chart if any
  updatePoolsAPR();
}

/* -----------------------------
   UI Renderers
   ----------------------------- */
function renderMarket(){
  const el = document.getElementById('marketList');
  el.innerHTML = '';
  STATE.artists.forEach(a=>{
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = `<div>
      <div class="ticker">${a.ticker}</div>
      <div class="small">${a.name} • vol ${(a.volatility*100).toFixed(1)}%</div>
    </div>
    <div style="text-align:right">
      <div style="font-weight:800">₳ ${a.price}</div>
      <div style="margin-top:6px;display:flex;gap:6px;justify-content:flex-end">
        <button class="btn ghost" data-t="${a.ticker}" data-act="view">View</button>
        <button class="btn" data-t="${a.ticker}" data-act="buy">Buy</button>
      </div>
    </div>`;
    el.appendChild(div);
  });
  // attach listeners
  document.querySelectorAll('[data-act]').forEach(btn=>{
    btn.onclick = (e)=>{
      const t = e.currentTarget.getAttribute('data-t');
      const act = e.currentTarget.getAttribute('data-act');
      const a = STATE.artists.find(x=>x.ticker===t);
      if(act==='view'){ selectArtist(a.ticker); }
      if(act==='buy'){ buyArtist(a.ticker,10); }
    };
  });
}

/* Chart.js wrapper (lazy load Chart.js) */
let CHART = null;
async function ensureChart(){
  if(window.Chart) return;
  await loadScript('https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js');
}
async function updateChart(){
  const sel = STATE.selected;
  const ctx = document.getElementById('priceChart').getContext('2d');
  if(!sel) { ctx.canvas.style.opacity=0.3; return; }
  await ensureChart();
  const a = STATE.artists.find(x=>x.ticker===sel);
  const labels = a.history.map(h=>new Date(h.t).toLocaleTimeString());
  const data = a.history.map(h=>h.p);
  if(CHART){ CHART.data.labels = labels; CHART.data.datasets[0].data = data; CHART.update(); return; }
  CHART = new Chart(ctx,{type:'line',data:{labels,datasets:[{label:a.ticker,data,fill:true,tension:0.25,borderColor:'#6E00FF',backgroundColor:'rgba(110,0,255,0.12)'}]},options:{plugins:{legend:{display:false}},scales:{x:{display:false}}}});
}

/* Select artist */
function selectArtist(ticker){
  STATE.selected = ticker;
  document.getElementById('selectedLabel').innerText = ticker;
  updateChart();
}

/* Portfolio ops (simulated) */
function portfolioValue(){
  let total = 0;
  Object.keys(STATE.portfolio).forEach(t=>{
    const qty = STATE.portfolio[t];
    const a = STATE.artists.find(x=>x.ticker===t);
    if(a) total += qty * a.price;
  });
  return Math.round(total);
}
function buyArtist(ticker,qty){
  STATE.portfolio[ticker] = (STATE.portfolio[ticker]||0)+qty;
  saveLS();
  document.getElementById('portfolioValue').innerText = `₳ ${portfolioValue()}`;
  // small reward
  givePoints(2);
  alert(`Bought ${qty} of ${ticker} in simulation.`);
}
function sellArtist(ticker,qty){
  const cur = STATE.portfolio[ticker]||0;
  const sold = Math.min(cur,qty);
  STATE.portfolio[ticker] = cur - sold;
  if(STATE.portfolio[ticker] <= 0) delete STATE.portfolio[ticker];
  saveLS();
  document.getElementById('portfolioValue').innerText = `₳ ${portfolioValue()}`;
  alert(`Sold ${sold} of ${ticker} in simulation.`);
}

/* -----------------------------
   Pools APR adjusts with "hype"
   ----------------------------- */
function updatePoolsAPR(){
  STATE.pools.forEach(p=>{
    const a = STATE.artists.find(x=>x.ticker===p.artist);
    // APR base + enthusiasm factor
    const base = 5 + Math.random()*3;
    const hype = clamp((Math.log10(a.price+1)-2)*4, -2, 12); // heuristic
    p.apr = Math.round((base + hype)*10)/10;
  });
  renderPools();
}
function renderPools(){
  const el = document.getElementById('pools');
  el.innerHTML='';
  STATE.pools.forEach(p=>{
    const a = STATE.artists.find(x=>x.ticker===p.artist);
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div>
      <div style="font-weight:800">${a.name}</div>
      <div class="small">Pool • APR ${p.apr}%</div>
    </div>
    <div style="text-align:right">
      <div style="font-weight:700">${p.staked} staked</div>
      <div style="margin-top:8px">
        <button class="btn" data-p="${p.id}" data-act="stake">Stake 50</button>
        <button class="btn ghost" data-p="${p.id}" data-act="unstake">Unstake</button>
      </div>
    </div>`;
    el.appendChild(div);
  });
  document.querySelectorAll('[data-act]').forEach(b=>{
    const act = b.getAttribute('data-act');
    if(act==='stake') b.onclick = ()=>{ stakePool(b.getAttribute('data-p'),50); };
    if(act==='unstake') b.onclick = ()=>{ unstakePool(b.getAttribute('data-p')); };
  });
}
function stakePool(id,amount){
  const p = STATE.pools.find(x=>x.id===id);
  p.staked += amount;
  givePoints(5);
  saveLS();
  updatePoolsAPR();
  alert(`Staked ${amount} in ${p.artist} pool.`);
}
function unstakePool(id){
  const p = STATE.pools.find(x=>x.id===id);
  p.staked = Math.max(0,p.staked - 50);
  saveLS();
  updatePoolsAPR();
  alert('Unstaked 50');
}

/* -----------------------------
   Leaderboard (local)
   ----------------------------- */
function givePoints(n){
  if(!STATE.softWallet){ // if no soft wallet, create one automatically
    createSoftWallet();
  }
  STATE.softWallet.points = (STATE.softWallet.points||0) + n;
  document.getElementById('pointsBal').innerText = `${STATE.softWallet.points} AFRO`;
  // update leaderboard: simple entry keyed by address
  const id = STATE.softWallet.address.slice(0,8);
  let slot = STATE.leaderboard.find(x=>x.id===id);
  if(!slot){ slot={id:id,name:`Fan-${id}`,points:0}; STATE.leaderboard.push(slot); }
  slot.points += n;
  // sort top-10
  STATE.leaderboard.sort((a,b)=>b.points-a.points);
  if(STATE.leaderboard.length>10) STATE.leaderboard.length=10;
  saveLS();
  renderLeaderboard();
}
function renderLeaderboard(){
  const el = document.getElementById('leaderboard');
  el.innerHTML='';
  STATE.leaderboard.forEach((p,idx)=>{
    const div = document.createElement('div'); div.className='lb-item';
    div.innerHTML = `<div>${idx+1}. ${p.name}</div><div style="display:flex;gap:8px;align-items:center"><div class="smallmuted">${p.points} pts</div></div>`;
    el.appendChild(div);
  });
}

/* -----------------------------
   Soft Wallet (local-only)
   ----------------------------- */
async function createSoftWallet(){
  // lazy import ethers (already available later) - create random wallet
  if(!window.ethers){
    await loadScript('https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js');
  }
  const wallet = window.ethers.Wallet.createRandom();
  STATE.softWallet = { privateKey: wallet.privateKey, address: wallet.address, points:0, ts: now() };
  saveLS();
  document.getElementById('walletInfo').innerHTML = `<div style="font-size:13px">Soft: <strong class="small">${STATE.softWallet.address}</strong></div>`;
  document.getElementById('pointsBal').innerText = `0 AFRO`;
  renderLeaderboard();
}

/* -----------------------------
   WalletConnect (external)
   - For demo we use WalletConnectProvider (v1) via CDN
   - In production: use WalletConnect v2 + Web3Modal and bundle dependencies
   ----------------------------- */
let WC_PROVIDER = null;
async function connectWallet(){
  try{
    if(!window.WalletConnectProvider){
      await loadScript('https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js');
    }
    WC_PROVIDER = new window.WalletConnectProvider.default({ infuraId: 'demo' }); // replace in prod
    await WC_PROVIDER.enable();
    // wrap with ethers provider
    if(!window.ethers) await loadScript('https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js');
    const provider = new ethers.BrowserProvider(WC_PROVIDER);
    const signer = await provider.getSigner();
    STATE.web3Provider = provider;
    STATE.web3Signer = signer;
    const addr = await signer.getAddress();
    document.getElementById('walletInfo').innerHTML = `<div style="font-size:13px">Connected: <strong class="small">${addr}</strong></div><div class="smallmuted">WalletConnect</div>`;
  }catch(e){
    console.error('connectWallet',e);
    alert('Failed to connect wallet: ' + (e.message||e));
  }
}

/* Sign a message to verify fan identity */
async function signFanMessage(){
  if(!STATE.web3Signer) return alert('Connect a wallet first');
  try{
    const addr = await STATE.web3Signer.getAddress();
    const msg = `I am an AfroGenstas fan — ${addr} — ${Math.floor(now()/1000)}`;
    const sig = await STATE.web3Signer.signMessage(msg);
    alert('Signed message (copy):\n' + sig);
    // Optionally store the signed proof locally; server verify later
    localStorage.setItem('lastFanProof', JSON.stringify({addr,msg,sig,ts:now()}));
  }catch(e){ console.error(e); alert('Sign failed'); }
}

/* -----------------------------
   AI (Gemini) placeholder
   - demo: shows how to batch & cache
   - real integration: send prompts to Gemini API server-side (do not put secrets in client)
   ----------------------------- */
async function generateAiInsight(scope='lite'){
  const cacheKey = `ai:${scope}:summary`;
  const cached = STATE.aiCache[cacheKey];
  const TTL = (scope==='lite')? (60*60*24) : (60*60); // lite daily, deep hourly (demo)
  if(cached && (now() - cached.ts) < TTL*1000){
    document.getElementById('aiOutput').innerText = `[cached] ` + cached.content;
    return;
  }
  // Demo generation (in real app: call server that forwards to Gemini with billing)
  const sample = (scope==='lite') ?
    `Gemini-Lite Summary: Top movers this week: $BURNA, $ZINO. Suggested watch: $TEM for long-term stability.` :
    `Gemini-Deep: Portfolio backtest suggests a tempo rotation: overweight $BURNA during album cycles, hedge $WIZK with $TEM. Confidence: 72%.`;
  const out = sample + ` (simulated)`;
  STATE.aiCache[cacheKey] = {ts: now(), content: out};
  document.getElementById('aiOutput').innerText = out;
}

/* -----------------------------
   Helper: dynamic script loader
   ----------------------------- */
function loadScript(src){
  return new Promise((res,rej)=>{
    const s = document.createElement('script'); s.src=src; s.async=true;
    s.onload = ()=>res(); s.onerror = (e)=>rej(e);
    document.head.appendChild(s);
  });
}

/* -----------------------------
   Three.js demo (lazy-loaded)
   ----------------------------- */
let THREE_LOADED = false;
async function initThree(){
  if(THREE_LOADED) return;
  await loadScript('https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js');
  await loadScript('https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js');
  THREE_LOADED = true;
  const wrap = document.getElementById('threeWrap');
  const W = wrap.clientWidth, H = wrap.clientHeight;
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(45, W/H, 0.1, 1000);
  camera.position.set(0,2,6);
  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(W,H); renderer.setClearColor(0x05060a,1);
  wrap.appendChild(renderer.domElement);
  const light = new THREE.PointLight(0xffffff,1); light.position.set(5,5,5); scene.add(light);
  const geo = new THREE.IcosahedronGeometry(1.4,1);
  const mat = new THREE.MeshStandardMaterial({color:0x6e00ff,metalness:0.6,roughness:0.2,emissive:0x200040});
  const orb = new THREE.Mesh(geo,mat); scene.add(orb);
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  let ang = 0;
  function animate(){ requestAnimationFrame(animate); orb.rotation.y += 0.005; controls.update(); renderer.render(scene,camera); }
  animate();
  wrap.onclick = ()=> { orb.rotation.y += 0.6; };
}

/* -----------------------------
   PWA install & service worker
   - registers sw and handles install prompt
   ----------------------------- */
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('btnInstall').style.display='inline-block';
});
document.getElementById('btnInstall').onclick = async ()=>{
  if(!deferredPrompt) return alert('Install not available');
  deferredPrompt.prompt();
  const choice = await deferredPrompt.userChoice;
  if(choice.outcome === 'accepted') alert('App installed!');
  deferredPrompt = null;
};

/* Register a basic service worker inline (we will create programmatic SW via blob for single-file demo) */
async function registerSW(){
  if('serviceWorker' in navigator){
    const swCode = `
    const CACHE = 'afrogenstas-demo-v1';
    const ASSETS = ['/', location.pathname];
    self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))); });
    self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))); });
    `;
    const blob = new Blob([swCode], {type:'text/javascript'});
    const url = URL.createObjectURL(blob);
    try{ await navigator.serviceWorker.register(url); console.log('SW registered'); }catch(e){console.warn('SW failed',e); }
  }
}

/* -----------------------------
   Wire UI buttons
   ----------------------------- */
document.getElementById('softWalletBtn').addEventListener('click', ()=>{ createSoftWallet(); });
document.getElementById('connectBtn').addEventListener('click', ()=>{ connectWallet(); });
document.getElementById('earnBtn').addEventListener('click', ()=>{ givePoints(10); });
document.getElementById('redeemBtn').addEventListener('click', ()=>{ alert('Redeem flow is demo-only — will open in v2.'); });
document.getElementById('buyBtn').addEventListener('click', ()=>{ if(STATE.selected) buyArtist(STATE.selected,10); else alert('Select an artist first'); });
document.getElementById('sellBtn').addEventListener('click', ()=>{ if(STATE.selected) sellArtist(STATE.selected,10); else alert('Select an artist first'); });
document.getElementById('stakeBtn').addEventListener('click', ()=>{ if(STATE.selected){ const pool = STATE.pools[0]; stakePool(pool.id,50);} else alert('Select artist to stake'); });
document.getElementById('claimBtn').addEventListener('click', ()=>{ alert('Claim rewards demo — in prod this will calculate staking yield.'); });
document.getElementById('shareBtn').addEventListener('click', ()=>{ try{ navigator.share && navigator.share({title:'My AfroGenstas Score',text:'Check my AfroPoints score!',url:location.href}); }catch(e){ alert('Sharing not supported on this device'); } });
document.getElementById('joinLeague').addEventListener('click', ()=>{ alert('Joined league (demo).'); });
document.getElementById('aiGenBtn').addEventListener('click', ()=>{ generateAiInsight('lite'); });
document.getElementById('aiDeepBtn').addEventListener('click', ()=>{ generateAiInsight('deep'); });

document.getElementById('btnNeon').addEventListener('click', (e)=>{ document.getElementById('btnNeon').classList.add('active'); document.getElementById('btnContrast').classList.remove('active'); document.documentElement.style.setProperty('--bg','#0B1020'); });
document.getElementById('btnContrast').addEventListener('click', (e)=>{ document.getElementById('btnContrast').classList.add('active'); document.getElementById('btnNeon').classList.remove('active'); document.documentElement.style.setProperty('--bg','#000'); });

document.getElementById('btnStart').addEventListener('click', ()=>{ document.querySelector('main').scrollIntoView({behavior:'smooth'}); });

document.getElementById('btnEdit').addEventListener('click', ()=>{
  const example = JSON.stringify({home:{hero:{heading:'Play the Market. Feel the Rhythm.'}}},null,2);
  const got = prompt('Paste content JSON to override (demo):', example);
  if(!got) return;
  try{ localStorage.setItem('afro_content_override', got); alert('Saved locally — reload to view.'); }catch(e){ alert('Invalid JSON'); }
});

/* -----------------------------
   App bootstrap
   ----------------------------- */
loadLS();
initArtists();
renderMarket();
renderPools();
renderLeaderboard();
document.getElementById('portfolioValue').innerText = `₳ ${portfolioValue()}`;
registerSW();

// start price sim tick
setInterval(stepPriceSim, 4500); // every 4.5s for demo rapidity

// lazy load three.js when panel in view
const ro = new IntersectionObserver((entries)=>{
  entries.forEach(en=>{
    if(en.isIntersecting){ initThree(); ro.disconnect(); }
  });
},{threshold:0.2});
ro.observe(document.getElementById('threeWrap'));

/* Expose some test hooks for dev console */
window.AG = {STATE, stepPriceSim, buyArtist, sellArtist, createSoftWallet, connectWallet, generateAiInsight, signFanMessage};
</script>
</body>
</html>