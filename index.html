<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AfroGenstas — Music Meets Finance</title>

<!-- Libraries (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  /* ---------- Visual theme ---------- */
  :root{
    --bg:#06060a;
    --panel:linear-gradient(180deg,#0c0f1a,#0b1220);
    --muted:#9aa7bd;
    --accent1:#ff7f50;
    --accent2:#7c5cff;
    --glass:rgba(255,255,255,0.03);
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background: radial-gradient(800px 400px at 10% 10%, rgba(124,92,255,0.045), transparent), var(--bg);
    color:#eaf2ff;
    -webkit-font-smoothing:antialiased;
  }
  header{
    position:sticky;top:0;z-index:50;
    display:flex;align-items:center;justify-content:space-between;padding:12px 18px;
    background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.25));
    border-bottom:1px solid rgba(255,255,255,0.03);
    backdrop-filter:blur(6px);
  }
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:grid;place-items:center;font-weight:900;color:#021;box-shadow:0 8px 30px rgba(124,92,255,0.12)}
  .title{font-weight:800}
  .tag{color:var(--muted);font-size:.86rem}

  nav{display:flex;gap:10px;align-items:center}
  nav a{color:var(--muted);text-decoration:none;padding:8px 10px;border-radius:8px}
  nav a.active{color:#fff;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01))}

  main{max-width:1200px;margin:18px auto;padding:12px;display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:1000px){ main{grid-template-columns:720px 1fr} }

  .card{background:var(--panel);border:1px solid rgba(255,255,255,0.03);padding:16px;border-radius:var(--radius);box-shadow: 0 10px 40px rgba(2,6,23,0.6)}
  h1,h2,h3{margin:0}
  .muted{color:var(--muted);font-size:.95rem}

  .hero{padding:22px;border-radius:12px;background:linear-gradient(90deg, rgba(124,92,255,0.07), rgba(255,127,80,0.02));display:flex;flex-direction:column;gap:10px}
  .cta-row{display:flex;gap:10px;flex-wrap:wrap}

  .btn{background:linear-gradient(90deg,var(--accent2),var(--accent1));border:none;padding:10px 14px;border-radius:10px;color:#021;font-weight:800;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff}

  .ticker{display:flex;gap:10px;overflow-x:auto;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);white-space:nowrap}
  .tick{min-width:150px;padding:8px 10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);display:flex;justify-content:space-between;gap:8px;align-items:center}
  .tick .sym{font-weight:800}
  .tick .chg.up{color:#2dd4bf}
  .tick .chg.down{color:#ff6b6b}

  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  th{color:var(--accent1);font-weight:700}

  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}

  .sketch{width:100%;height:220px;border-radius:10px;border:0}

  .toast{position:fixed;right:16px;bottom:16px;background:linear-gradient(90deg,var(--accent2),var(--accent1));padding:10px 14px;border-radius:10px;color:#021;font-weight:700;z-index:120}

  footer{padding:18px;text-align:center;color:var(--muted);font-size:.95rem;margin-top:14px}
</style>
</head>
<body>

<!-- 3D animated background -->
<canvas id="bgCanvas" style="position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.45"></canvas>

<header>
  <div class="brand">
    <div class="logo" aria-hidden="true">AG</div>
    <div>
      <div class="title">AfroGenstas</div>
      <div class="tag">Music · Finance · Culture</div>
    </div>
  </div>

  <nav>
    <a href="#market" data-route="market" class="active">Market</a>
    <a href="#portfolio" data-route="portfolio">Portfolio</a>
    <a href="#leaderboard" data-route="leaderboard">Leaderboard</a>
    <a href="#news" data-route="news">News</a>
  </nav>
</header>

<main>
  <!-- application mount -->
  <section id="app" class="card" style="z-index:10"></section>

  <!-- sidebar -->
  <aside style="z-index:10">
    <div class="card">
      <h3>Live Ticker</h3>
      <div id="ticker" class="ticker muted small" role="list"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Portfolio Snapshot</h3>
      <div id="snapshot" class="muted small">—</div>
      <div style="margin-top:10px" class="controls">
        <button id="btnPdf" class="btn">Download PDF</button>
        <button id="btnReset" class="btn ghost">Reset</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>3D Visual</h3>
      <iframe class="sketch" title="Afro Visual" src="https://sketchfab.com/models/8208f257d2d3457183e866eb990e6511/embed"></iframe>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Sponsored</h3>
      <div class="muted small">Ad Slot — insert AdSense after verification</div>
      <!-- AdSense placeholder (commented). Replace purchaser ID and ad-slot in production.
      <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXX" crossorigin="anonymous"></script>
      <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-XXXXXXXXXXXX" data-ad-slot="1234567890" data-ad-format="auto" data-full-width-responsive="true"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      -->
    </div>
  </aside>
</main>

<footer>© 2025 AfroGenstas — Music Meets Finance</footer>

<script>
/* ============================================================================
   AfroGenstas Single-file Web App
   - Copy this file to afrogenstas.html and open in a modern browser.
   - For production: deploy serverless summarizer and analytics services; replace config urls.
   ============================================================================
*/

/* ---------------- CONFIG ----------------
   - APP_CONFIG.SERVER_SUMMARIZE_URL: optional serverless summarizer endpoint (POST {text})
   - APP_CONFIG.OPENBB_URL: optional analytics microservice endpoint (POST /analytics/metrics with {name, series})
   Do NOT place secret OpenAI keys in client code for production.
*/
const APP_CONFIG = {
  SERVER_SUMMARIZE_URL: "", // e.g. "https://your-site.vercel.app/api/summarize"
  OPENBB_URL: ""           // e.g. "https://openbb-analytics.example.com"
};

/* ---------------- Mock Artists & Price State ---------------- */
const ARTISTS = [
  { name: "Burna Boy", ticker: "$BURNA", color: "#FF7F50" },
  { name: "Asake", ticker: "$ASAKE", color: "#7C5CFF" },
  { name: "Rema", ticker: "$REMA", color: "#39D98A" },
  { name: "Wizkid", ticker: "$WIZ", color: "#FFD166" },
  { name: "Ayra Starr", ticker: "$AYRA", color: "#4BC0C8" }
];

const priceState = {}; // ticker -> {history:[], last}
function initPrices(){
  ARTISTS.forEach(a=>{
    const base = 80 + Math.random() * 220;
    priceState[a.ticker] = { history: Array.from({length:40}, (_,i)=> Math.round((base + Math.sin(i/4)*8 + Math.random()*6)*100)/100), last: Math.round(base*100)/100 };
  });
  updatePricesLoop();
}

/* ---------------- Portfolio storage ---------------- */
const LS_KEY = "afrogenstas_portfolio_v3";
function defaultPortfolio(){ return { cash: 15000, holdings: {}, history: [] }; }
function loadPortfolio(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || defaultPortfolio(); } catch(e){ return defaultPortfolio(); } }
function savePortfolio(p){ localStorage.setItem(LS_KEY, JSON.stringify(p)); }
let PORTFOLIO = loadPortfolio();

/* ---------------- Leaderboard (sample) ---------------- */
let LEADERBOARD = [
  { user: "Keita", value: 32200 },
  { user: "Aisha", value: 27140 },
  { user: "Tunde", value: 19870 },
  { user: "You", value: 0 } // updated live
];

/* ---------------- Utilities ---------------- */
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const k in attrs) e.setAttribute(k, attrs[k]);
  children.forEach(c => typeof c === 'string' ? e.appendChild(document.createTextNode(c)) : e.appendChild(c));
  return e;
}
function fmt(v){ return "$" + Number(v).toLocaleString(undefined, { minimumFractionDigits:2, maximumFractionDigits:2 }); }
function nowISO(){ return new Date().toISOString(); }
function toast(msg, t=2600){
  const d = el('div', { class: 'toast' }, msg);
  document.body.appendChild(d);
  setTimeout(()=> d.remove(), t);
}
function hexToRgba(hex, a=0.12){
  const c = hex.replace('#','');
  const r = parseInt(c.substring(0,2),16), g = parseInt(c.substring(2,4),16), b = parseInt(c.substring(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

/* ---------------- Price simulation loop ---------------- */
function randWalk(prev){ return Math.max(1, prev * (1 + (Math.random()-0.5) * 0.03)); }
function updatePricesLoop(){
  ARTISTS.forEach(a => {
    const s = priceState[a.ticker];
    s.last = Math.round(randWalk(s.last) * 100) / 100;
    s.history.push(s.last);
    if(s.history.length > 180) s.history.shift();
  });
  renderTicker();
  if(currentRoute === 'market') renderMarketBody();
  if(currentRoute === 'portfolio') updateHoldingsTable();
  setTimeout(updatePricesLoop, 3000 + Math.random()*2000);
}

/* ---------------- Routing ---------------- */
const routes = {
  market: renderMarket,
  portfolio: renderPortfolio,
  leaderboard: renderLeaderboard,
  news: renderNews
};
let currentRoute = 'market';
function navTo(route){
  currentRoute = route;
  document.querySelectorAll('nav a').forEach(a => a.classList.toggle('active', a.dataset.route === route));
  history.pushState({ route }, "", `#${route}`);
  routes[route]();
}
window.addEventListener('popstate', ()=> {
  const route = location.hash.replace('#','') || 'market';
  if(routes[route]) navTo(route); else navTo('market');
});
document.querySelectorAll('nav a').forEach(a => a.addEventListener('click', e => { e.preventDefault(); navTo(a.dataset.route); }));

/* ---------------- Ticker rendering ---------------- */
function renderTicker(){
  const elTick = document.getElementById('ticker');
  if(!elTick) return;
  elTick.innerHTML = '';
  ARTISTS.forEach(a => {
    const s = priceState[a.ticker];
    const prev = s.history[s.history.length - 2] || s.last;
    const pct = ((s.last - prev) / prev) * 100;
    const div = el('div', { class: 'tick' });
    div.innerHTML = `<div><div class="sym">${a.ticker}</div><div class="muted small">${a.name}</div></div>
                     <div style="text-align:right"><div style="font-weight:800">${s.last.toFixed(2)}</div><div class="chg ${pct>=0?'up':'down'}">${pct>=0?'+':''}${pct.toFixed(2)}%</div></div>`;
    elTick.appendChild(div);
  });
}

/* ---------------- Market page ---------------- */
let marketCharts = {};
function renderMarket(){
  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="hero">
      <h2>Artist Market</h2>
      <p class="muted">Follow artist prices, view history, trade, and track analytics. Connect real streaming data and analytics via the extension hooks.</p>
      <div class="cta-row">
        <button id="btnExplore" class="btn">Explore</button>
        <button id="gotoPortfolio" class="btn ghost">Portfolio</button>
      </div>
    </div>

    <div style="margin-top:12px" class="card">
      <h3>Market Ticker</h3>
      <div id="marketTicker" class="ticker muted small"></div>
    </div>

    <div style="margin-top:12px" class="card">
      <h3>Artists</h3>
      <table>
        <thead><tr><th>Artist</th><th>Ticker</th><th>Price</th><th>7-sample Trend</th><th>Actions</th></tr></thead>
        <tbody id="marketTable"></tbody>
      </table>
    </div>
  `;
  document.getElementById('btnExplore').addEventListener('click', ()=> document.getElementById('marketTable').scrollIntoView({ behavior:'smooth' }));
  document.getElementById('gotoPortfolio').addEventListener('click', ()=> navTo('portfolio'));
  renderMarketBody();
}

function renderMarketBody(){
  const mt = document.getElementById('marketTable');
  const mk = document.getElementById('marketTicker');
  if(!mt || !mk) return;
  mt.innerHTML = ''; mk.innerHTML = '';
  ARTISTS.forEach((a, idx) => {
    const s = priceState[a.ticker];
    const hist = s.history.slice(-14);
    const trend = ((hist[hist.length-1] - hist[0]) / hist[0]) * 100;
    const tr = el('tr');
    tr.innerHTML = `<td>${a.name}</td><td>${a.ticker}</td><td>${s.last.toFixed(2)}</td><td>${trend>=0?'+':''}${trend.toFixed(1)}%</td>
      <td>
        <div class="controls">
          <button class="btn" data-buy="${idx}">Buy</button>
          <button class="btn ghost" data-view="${a.ticker}">View</button>
        </div>
      </td>`;
    mt.appendChild(tr);

    // ticker row
    const div = el('div', { class: 'tick' });
    div.innerHTML = `<div><strong>${a.ticker}</strong><div class="muted small">${a.name}</div></div><div style="text-align:right"><div style="font-weight:800">${s.last.toFixed(2)}</div></div>`;
    mk.appendChild(div);
  });

  // delegate
  mt.querySelectorAll('[data-buy]').forEach(b => b.addEventListener('click', e => {
    const idx = Number(e.currentTarget.dataset.buy);
    openTradeOverlay('BUY', ARTISTS[idx].ticker);
  }));
  mt.querySelectorAll('[data-view]').forEach(b => b.addEventListener('click', e => {
    const ticker = e.currentTarget.dataset.view;
    openArtistPanel(ticker);
  }));
}

/* ---------------- Artist panel (view + analytics + predict) ---------------- */
function openArtistPanel(ticker){
  const artist = ARTISTS.find(a => a.ticker === ticker);
  const s = priceState[ticker];
  const app = document.getElementById('app');
  app.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h2>${artist.name} <small style="color:var(--muted)">${artist.ticker}</small></h2>
        <div class="muted small">Last: ${s.last.toFixed(2)}</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="backMarket" class="btn ghost">Back</button>
        <button id="tradeArtist" class="btn">Trade</button>
      </div>
    </div>

    <div style="margin-top:12px" class="card">
      <canvas id="artistChart" style="height:220px"></canvas>
      <div style="margin-top:12px" class="controls">
        <button id="btnPredict" class="btn ghost">Predict Trend</button>
        <button id="btnSummary" class="btn">AI Summary</button>
      </div>
      <div id="artistInfo" style="margin-top:12px" class="muted small"></div>
    </div>
  `;
  document.getElementById('backMarket').addEventListener('click', ()=> renderMarket());
  document.getElementById('tradeArtist').addEventListener('click', ()=> openTradeOverlay('BUY', ticker));

  // chart
  const series = s.history.slice(-80);
  const ctx = document.getElementById('artistChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: { labels: series.map((_,i)=>i), datasets: [{ label: artist.ticker, data: series, borderColor: artist.color, backgroundColor: hexToRgba(artist.color, .12), fill:true, tension:0.28 }]},
    options: { plugins:{legend:{display:false}}, scales:{x:{display:false}}}
  });

  document.getElementById('btnPredict').addEventListener('click', async ()=>{
    const info = document.getElementById('artistInfo'); info.textContent = 'Analyzing…';
    const pred = predictTrend(series);
    info.innerHTML = `<strong>Prediction</strong>: ${pred.direction} • Confidence ${Math.round(pred.confidence*100)}% • Next ${pred.next.toFixed(2)}`;
    if(APP_CONFIG.OPENBB_URL){
      try{
        const res = await fetch(APP_CONFIG.OPENBB_URL + '/analytics/metrics', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: artist.ticker, series })});
        const j = await res.json();
        info.innerHTML += `<br/><small class="muted">OpenBB — Sharpe: ${j.sharpe?.toFixed(2) ?? '-'} • VolAnn: ${(j.volatility_ann*100).toFixed(2)}%</small>`;
      }catch(err){ console.warn('OpenBB call failed',err); }
    }
  });

  document.getElementById('btnSummary').addEventListener('click', async ()=>{
    const info = document.getElementById('artistInfo'); info.textContent = 'Summarizing…';
    try{
      const text = `${artist.name} price update — latest price ${s.last} — snapshot of recent movement.`;
      const summary = await summarize(text);
      info.innerHTML = `<div>${summary.replace(/\n/g,'<br/>')}</div>`;
    }catch(err){ info.textContent = 'Summary failed: ' + err.message; }
  });
}

/* ---------------- Trade overlay (inline) ---------------- */
function openTradeOverlay(side='BUY', ticker=null){
  const app = document.getElementById('app');
  const overlay = el('div', { class: 'card', style: 'position:relative;margin-bottom:12px' });
  overlay.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h3>${side} ${ticker ? ticker : ''}</h3><div class="muted small">Instant trade</div></div>
      <div><button id="closeTrade" class="btn ghost">Close</button></div>
    </div>
    <div style="margin-top:12px" class="controls">
      <select id="tradeTicker" class="input">${ARTISTS.map(a=>`<option value="${a.ticker}">${a.ticker} — ${a.name}</option>`).join('')}</select>
      <input id="tradeQty" class="input" type="number" min="1" value="1" style="width:90px" />
      <button id="tradeConfirm" class="btn">${side}</button>
    </div>
    <div id="tradeInfo" class="muted small" style="margin-top:8px"></div>
  `;
  app.prepend(overlay);
  if(ticker) overlay.querySelector('#tradeTicker').value = ticker;
  overlay.querySelector('#closeTrade').addEventListener('click', ()=> overlay.remove());
  overlay.querySelector('#tradeConfirm').addEventListener('click', ()=>{
    const t = overlay.querySelector('#tradeTicker').value;
    const q = Math.max(1, Math.floor(Number(overlay.querySelector('#tradeQty').value) || 1));
    executeTrade(side, t, q);
    overlay.remove();
  });
  const info = overlay.querySelector('#tradeInfo');
  const updateInfo = ()=> {
    const t = overlay.querySelector('#tradeTicker').value;
    const q = Math.max(1, Math.floor(Number(overlay.querySelector('#tradeQty').value) || 1));
    const price = priceState[t].last;
    info.innerHTML = `Price: <strong>${price.toFixed(2)}</strong> • Total: <strong>${(price*q).toFixed(2)}</strong>`;
  };
  overlay.querySelector('#tradeTicker').addEventListener('change', updateInfo);
  overlay.querySelector('#tradeQty').addEventListener('input', updateInfo);
  updateInfo();
}

/* ---------------- Execute trade ---------------- */
function executeTrade(side, ticker, qty){
  const price = priceState[ticker].last;
  if(side === 'BUY'){
    const cost = price * qty;
    if(cost > PORTFOLIO.cash){ toast('Insufficient cash'); return; }
    const h = PORTFOLIO.holdings[ticker] || { qty:0, avg:0 };
    const newQty = h.qty + qty;
    const newAvg = ((h.avg * h.qty) + price * qty) / newQty;
    PORTFOLIO.holdings[ticker] = { qty: newQty, avg: newAvg };
    PORTFOLIO.cash -= cost;
    PORTFOLIO.history.push({ t: nowISO(), action: 'BUY', ticker, qty, price });
    toast(`Bought ${qty} ${ticker} @ ${price.toFixed(2)}`);
  } else {
    const h = PORTFOLIO.holdings[ticker];
    if(!h || h.qty <= 0){ toast('No holdings to sell'); return; }
    const sellQty = Math.min(qty, h.qty);
    const proceeds = sellQty * price;
    h.qty -= sellQty;
    if(h.qty === 0) delete PORTFOLIO.holdings[ticker]; else PORTFOLIO.holdings[ticker] = h;
    PORTFOLIO.cash += proceeds;
    PORTFOLIO.history.push({ t: nowISO(), action: 'SELL', ticker, qty: sellQty, price });
    toast(`Sold ${sellQty} ${ticker} @ ${price.toFixed(2)}`);
  }
  savePortfolio(PORTFOLIO);
  updateHoldingsTable();
  drawPortfolioChart();
}

/* ---------------- Portfolio page ---------------- */
let PORT_CHART = null;
function renderPortfolio(){
  const app = document.getElementById('app');
  app.dataset.page = 'portfolio';
  app.innerHTML = `
    <h2>Your Portfolio</h2>
    <p class="muted">Manage holdings, view analytics, and download a PDF report.</p>

    <div style="margin-top:12px" class="card">
      <h3>Holdings</h3>
      <table>
        <thead><tr><th>Artist</th><th>Ticker</th><th>Qty</th><th>Avg Price</th><th>Last</th><th>Value</th><th>P/L</th><th>Action</th></tr></thead>
        <tbody id="holdingsTable"></tbody>
      </table>
      <div style="margin-top:12px" class="row">
        <div class="muted">Cash: <strong id="cashVal"></strong></div>
        <div style="margin-left:12px" class="muted">Portfolio Value: <strong id="totalVal"></strong></div>
        <div style="margin-left:auto"><button id="openTradeBtn" class="btn">Trade</button></div>
      </div>
    </div>

    <div style="margin-top:12px" class="card">
      <h3>Performance</h3>
      <canvas id="portfolioChart" style="height:220px"></canvas>
      <div id="portfolioMetrics" class="muted small" style="margin-top:8px"></div>
    </div>
  `;
  document.getElementById('openTradeBtn').addEventListener('click', ()=> openTradeOverlay('BUY'));
  updateHoldingsTable();
  drawPortfolioChart();
}

function updateHoldingsTable(){
  const tbody = document.getElementById('holdingsTable');
  const cashEl = document.getElementById('cashVal');
  const totalEl = document.getElementById('totalVal');
  if(!tbody) return;
  tbody.innerHTML = '';
  let equity = 0;
  for(const [ticker, h] of Object.entries(PORTFOLIO.holdings)){
    const artist = ARTISTS.find(a => a.ticker === ticker);
    const last = priceState[ticker].last;
    const value = last * h.qty;
    equity += value;
    const pl = (last - h.avg) * h.qty;
    const tr = el('tr');
    tr.innerHTML = `<td>${artist.name}</td><td>${ticker}</td><td>${h.qty}</td><td>${h.avg.toFixed(2)}</td><td>${last.toFixed(2)}</td><td>${value.toFixed(2)}</td><td style="color:${pl>=0? '#2dd4bf':'#ff6b6b'}">${pl>=0?'+':''}${pl.toFixed(2)}</td><td><button class="btn ghost" data-sell="${ticker}">Sell</button></td>`;
    tbody.appendChild(tr);
  }
  tbody.querySelectorAll('[data-sell]').forEach(b => b.addEventListener('click', e => openTradeOverlay('SELL', e.currentTarget.dataset.sell)));
  const total = equity + PORTFOLIO.cash;
  if(cashEl) cashEl.textContent = fmt(PORTFOLIO.cash);
  if(totalEl) totalEl.textContent = fmt(total);
  // update leaderboard entry for 'You'
  LEADERBOARD[3] = { user: 'You', value: Math.round(total) };
  renderLeaderboard();
  savePortfolio(PORTFOLIO);
  updateSnapshot();
}

/* ---------------- Portfolio chart & metrics ---------------- */
function getPortfolioSeries(){
  const length = 60;
  const series = [];
  for(let i=0;i<length;i++){
    let tot = 0;
    for(const [ticker,h] of Object.entries(PORTFOLIO.holdings)){
      const hist = priceState[ticker].history;
      const idx = Math.max(0, hist.length - length + i);
      const p = hist[idx] || hist[0] || 100;
      tot += p * h.qty;
    }
    series.push(tot + PORTFOLIO.cash);
  }
  return series;
}

function drawPortfolioChart(){
  const canvas = document.getElementById('portfolioChart');
  if(!canvas) return;
  const series = getPortfolioSeries();
  if(PORT_CHART) PORT_CHART.destroy();
  PORT_CHART = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: { labels: series.map((_,i)=>i), datasets: [{ data: series, borderColor:'#6c5cff', backgroundColor: hexToRgba('#6c5cff', .12), fill:true }]},
    options: { plugins:{legend:{display:false}}, scales:{x:{display:false}} }
  });
  const m = computeMetrics(series);
  const metricEl = document.getElementById('portfolioMetrics');
  if(metricEl) metricEl.innerHTML = `Annual Return: ${(m.annual_return*100).toFixed(2)}% • Vol (ann): ${(m.volatility_ann*100).toFixed(2)}% • Sharpe: ${m.sharpe.toFixed(2)}`;
}

/* ---------------- Leaderboard page ---------------- */
function renderLeaderboard(){
  const app = document.getElementById('app');
  app.dataset.page = 'leaderboard';
  app.innerHTML = `
    <h2>Leaderboard</h2>
    <p class="muted">Top fan portfolios</p>
    <div style="margin-top:12px" id="lbGrid" class="grid-cards"></div>
  `;
  const container = document.getElementById('lbGrid');
  LEADERBOARD.sort((a,b)=>b.value-a.value);
  container.innerHTML = '';
  LEADERBOARD.forEach((p,i)=>{
    const card = el('div', { class: 'card' });
    card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${i+1}. ${p.user}</strong><div class="muted small">Portfolio value</div></div><div style="font-weight:800">${fmt(p.value)}</div></div>`;
    container.appendChild(card);
  });
}

/* ---------------- News page (RSS aggregation) ---------------- */
const FEEDS = [
  { name: "Pulse Nigeria", url: "https://www.pulse.ng/entertainment/music/rss" },
  { name: "NotJustOk", url: "https://notjustok.com/feed/" }
];

async function renderNews(){
  const app = document.getElementById('app');
  app.dataset.page = 'news';
  app.innerHTML = `<h2>News</h2><p class="muted">Afrobeat headlines aggregated from trusted outlets.</p><div id="newsGrid" class="grid-cards" style="margin-top:12px"></div>`;
  const grid = document.getElementById('newsGrid');
  grid.innerHTML = '<div class="muted">Loading feeds…</div>';
  try{
    const cards = [];
    for(const feed of FEEDS){
      const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}`);
      if(!res.ok) continue;
      const j = await res.json();
      (j.items || []).slice(0,4).forEach(it=>{
        const c = el('a', { href: it.link, target: '_blank', class: 'card', style: 'text-decoration:none;color:inherit' });
        c.innerHTML = `<h3>${it.title}</h3><div class="muted small">${new Date(it.pubDate).toLocaleDateString()} • ${feed.name}</div><p class="muted small">${stripHtml(it.description).slice(0,160)}...</p>`;
        cards.push(c);
      });
    }
    grid.innerHTML = '';
    if(cards.length === 0) grid.innerHTML = '<div class="muted">No items found.</div>';
    cards.forEach(c => grid.appendChild(c));
  }catch(err){
    grid.innerHTML = `<div class="muted">Feed load error: ${err.message}</div>`;
    console.warn(err);
  }
}

/* ---------------- Helpers: summarizer, computeMetrics, predict ---------------- */
function stripHtml(html){ return (html||'').replace(/<[^>]+>/g,''); }
function localSummarizer(text){
  if(!text) return '';
  const sents = text.split(/[.?!]\s+/).filter(Boolean);
  if(sents.length <= 2) return text;
  const first = sents[0];
  const sorted = [...sents].sort((a,b)=>b.length-a.length);
  return `${first}. \n\n• ${sorted[0]}. \n\n• ${sorted[1]}.`;
}
async function summarize(text){
  if(APP_CONFIG.SERVER_SUMMARIZE_URL){
    const res = await fetch(APP_CONFIG.SERVER_SUMMARIZE_URL, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ text }) });
    if(!res.ok) throw new Error('Summarizer error: ' + res.status);
    const j = await res.json();
    return j.summary || j.result || 'No summary';
  } else {
    return localSummarizer(text);
  }
}

function computeMetrics(series){
  if(!Array.isArray(series) || series.length < 2) return { annual_return:0, volatility_ann:0, sharpe:0 };
  const rets = [];
  for(let i=1;i<series.length;i++) rets.push((series[i] - series[i-1]) / series[i-1]);
  const mean = rets.reduce((a,b)=>a+b,0)/rets.length;
  const variance = rets.reduce((a,b)=>a+(b-mean)*(b-mean),0) / Math.max(1, rets.length-1);
  const sd = Math.sqrt(variance);
  const volAnn = sd * Math.sqrt(252);
  const annReturn = mean * 252;
  const sharpe = volAnn > 0 ? annReturn / volAnn : 0;
  return { annual_return: annReturn, volatility_ann: volAnn, sharpe };
}

function predictTrend(series){
  const n = series.length;
  if(n < 6) return { next: series[series.length-1], direction: 'flat', confidence: 0.2 };
  let sumX=0,sumY=0,sumXY=0,sumXX=0;
  for(let i=0;i<n;i++){ sumX += i; sumY += series[i]; sumXY += i*series[i]; sumXX += i*i; }
  const b = (n*sumXY - sumX*sumY) / (n*sumXX - sumX*sumX);
  const a = (sumY - b*sumX) / n;
  const next = a + b*n;
  let ssRes=0, ssTot=0; const mean = sumY/n;
  for(let i=0;i<n;i++){ const pred = a + b*i; ssRes += (series[i]-pred)*(series[i]-pred); ssTot += (series[i]-mean)*(series[i]-mean); }
  const r2 = ssTot === 0 ? 0 : Math.max(0, 1 - (ssRes/ssTot));
  const confidence = Math.min(0.98, Math.max(0.05, r2));
  const direction = b > 0.001 ? 'up' : (b < -0.001 ? 'down' : 'flat');
  return { next, direction, confidence };
}

/* ---------------- PDF Report (jsPDF) ---------------- */
async function generatePdf(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  doc.setFontSize(16); doc.text("AfroGenstas — Portfolio Report", 40, 60);
  doc.setFontSize(11); doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 80);
  doc.text(`Cash: ${fmt(PORTFOLIO.cash)}`, 40, 100);
  let y = 120;
  doc.text("Holdings:", 40, y); y += 12;
  for(const [ticker, h] of Object.entries(PORTFOLIO.holdings)){
    const last = priceState[ticker].last;
    doc.text(`${ticker} — Qty: ${h.qty} — Avg: ${h.avg.toFixed(2)} — Last: ${last.toFixed(2)} — Value: ${(last*h.qty).toFixed(2)}`, 48, y);
    y += 12;
    if(y > 720){ doc.addPage(); y = 40; }
  }
  const series = getPortfolioSeries();
  const m = computeMetrics(series);
  y += 14;
  doc.text("Performance", 40, y);
  y+=12; doc.text(`Annual Return: ${(m.annual_return*100).toFixed(2)}%`, 48, y); y+=12;
  doc.text(`Volatility (ann): ${(m.volatility_ann*100).toFixed(2)}%`, 48, y); y+=12;
  doc.text(`Sharpe: ${m.sharpe.toFixed(3)}`, 48, y); 
  doc.save(`afrogenstas-portfolio-${Date.now()}.pdf`);
}
function getPortfolioSeries(){
  const len = 60; const series = [];
  for(let i=0;i<len;i++){
    let tot = 0;
    for(const [ticker,h] of Object.entries(PORTFOLIO.holdings)){
      const hist = priceState[ticker].history;
      const idx = Math.max(0, hist.length - len + i);
      tot += (hist[idx] || hist[0]) * h.qty;
    }
    series.push(tot + PORTFOLIO.cash);
  }
  return series;
}

/* ---------------- Helpers ---------------- */
function stripHtml(html){ return (html||'').replace(/<[^>]+>/g,''); }

/* ---------------- 3D background ---------------- */
function init3D(){
  const canvas = document.getElementById('bgCanvas');
  if(!canvas) return;
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(55, innerWidth/innerHeight, 0.1, 1000);
  camera.position.set(0,0,70);
  const geom = new THREE.TorusKnotGeometry(14,1.2,220,16);
  const mat = new THREE.MeshBasicMaterial({ color:0x6c5cff, wireframe:true, transparent:true, opacity:0.08 });
  const knot = new THREE.Mesh(geom, mat); scene.add(knot);
  const particles = new THREE.BufferGeometry(); const count = 1100;
  const pos = new Float32Array(count*3);
  for(let i=0;i<count;i++){ pos[i*3+0]=(Math.random()-0.5)*300; pos[i*3+1]=(Math.random()-0.5)*160; pos[i*3+2]=(Math.random()-0.5)*300; }
  particles.setAttribute('position', new THREE.BufferAttribute(pos,3));
  const points = new THREE.Points(particles, new THREE.PointsMaterial({ color:0x00e5ff, size:0.6, transparent:true, opacity:0.14 }));
  scene.add(points);
  function onResize(){ renderer.setSize(innerWidth, innerHeight); camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix(); }
  addEventListener('resize', onResize); onResize();
  let t=0; (function animate(){ t+=0.004; knot.rotation.x = t*0.5; knot.rotation.y = t*0.25; points.rotation.y = -t*0.02; renderer.render(scene, camera); requestAnimationFrame(animate); })();
}

/* ---------------- Snapshot & leaderboard update ---------------- */
function updateSnapshot(){
  const el = document.getElementById('snapshot'); if(!el) return;
  let equity = 0;
  for(const [ticker,h] of Object.entries(PORTFOLIO.holdings)){ equity += priceState[ticker].last * h.qty; }
  const total = PORTFOLIO.cash + equity;
  el.innerHTML = `<div><strong>${fmt(total)}</strong></div><div class="muted small">Cash ${fmt(PORTFOLIO.cash)} • Equity ${fmt(equity)}</div>`;
  // update leaderboard 'You' slot
  LEADERBOARD[3] = { user: 'You', value: Math.round(total) };
}

/* ---------------- Draw portfolio chart (helper) ---------------- */
function drawPortfolioChart(){
  if(document.getElementById('portfolioChart')){
    const series = getPortfolioSeries();
    if(window._portfolioChart) window._portfolioChart.destroy();
    const ctx = document.getElementById('portfolioChart').getContext('2d');
    window._portfolioChart = new Chart(ctx, {
      type:'line',
      data:{ labels: series.map((_,i)=>i), datasets:[{ data: series, borderColor:'#6c5cff', backgroundColor: hexToRgba('#6c5cff', .12), fill:true }]},
      options:{ plugins:{legend:{display:false}}, scales:{x:{display:false}}}
    });
    const m = computeMetrics(series);
    const mEl = document.getElementById('portfolioMetrics'); if(mEl) mEl.innerHTML = `Annual Return: ${(m.annual_return*100).toFixed(2)}% • Vol (ann): ${(m.volatility_ann*100).toFixed(2)}% • Sharpe: ${m.sharpe.toFixed(2)}`;
  }
}

/* ---------------- Draw leaderboard (sidebar update) ---------------- */
function renderLeaderboard(){
  const app = document.getElementById('app');
  if(currentRoute !== 'leaderboard'){
    // if just updating snapshot, render a small sidebar update
  }
  app.dataset.page = 'leaderboard';
  app.innerHTML = `<h2>Leaderboard</h2><p class="muted">Top community portfolios</p><div style="margin-top:12px" id="lbGrid" class="grid-cards"></div>`;
  const container = document.getElementById('lbGrid'); container.innerHTML = '';
  LEADERBOARD.sort((a,b)=>b.value - a.value).forEach((p,i)=>{
    const c = el('div', { class: 'card' });
    c.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${i+1}. ${p.user}</strong><div class="muted small">Value</div></div><div style="font-weight:800">${fmt(p.value)}</div></div>`;
    container.appendChild(c);
  });
}

/* ---------------- RSS feed helper (strip HTML used above) ---------------- */

/* ---------------- Start & wiring ---------------- */
initPrices();
init3D();

// initial route render
const initial = location.hash.replace('#','') || 'market';
navTo(initial in routes ? initial : 'market');

// wire quick controls
document.getElementById('btnPdf').addEventListener('click', generatePdf);
document.getElementById('btnReset').addEventListener('click', ()=> {
  if(confirm('Reset portfolio data?')){ PORTFOLIO = defaultPortfolio(); savePortfolio(PORTFOLIO); toast('Portfolio reset'); renderPortfolio(); }
});

// update snapshot on load
setTimeout(()=> { updateSnapshot(); renderTicker(); }, 800);

/* ---------------- Helper: get portfolio series (used in PDF and chart) ---------------- */
function getPortfolioSeries(){
  const length = 60; const series = [];
  for(let i=0;i<length;i++){
    let tot = 0;
    for(const [ticker,h] of Object.entries(PORTFOLIO.holdings)){
      const hist = priceState[ticker].history;
      const idx = Math.max(0, hist.length - length + i);
      tot += (hist[idx] || hist[0]) * h.qty;
    }
    series.push(tot + PORTFOLIO.cash);
  }
  return series;
}

/* ---------------- End of script ---------------- */
</script>
</body>
</html>
